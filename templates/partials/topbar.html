{# templates/partials/topbar.html #}
{% load rw_extras %}

<header class="rw-topbar" role="banner">

    <!-- LEFT: Brand / identity + mobile menu toggle -->
    <div class="rw-topbar-left">

        <!-- Mobile menu button (opens offcanvas sidebar) -->
        <button class="btn btn-sm btn-outline-secondary d-lg-none me-2"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#rwSidebarOffcanvas"
                aria-controls="rwSidebarOffcanvas"
                aria-label="Open menu">
            <i class="bi bi-list"></i>
        </button>

        <div class="rw-brand">
            <div class="rw-brand-name">AiScape</div>
            <div class="rw-brand-user">{{ request.user.username }}</div>
        </div>
    </div>

    <!-- CENTRE: Reporting tiles (read-only) -->
    <div class="rw-topbar-centre">
      <div class="rw-status-grid" aria-label="Active configuration status">

        {# TOP ROW (left): Language #}
        <div class="rw-status {% if rw_topbar_controls.enabled and rw_topbar_controls.language.overridden %}rw-status--overridden{% elif rw_language %}rw-status--overridden{% endif %}">
          <div class="rw-status-label">Language</div>
          <div class="rw-status-value">
            {% if rw_topbar_controls.enabled %}
              <select class="rw-status-select rw-topbar-select"
                      data-axis="language"
                      aria-label="Language override">
                <option value="" {% if not rw_topbar_controls.language.current %}selected{% endif %}>
                  {{ rw_topbar_controls.language.default_label }}
                </option>
                {% for opt in rw_topbar_controls.language.options %}
                  <option value="{{ opt.value }}" {% if rw_topbar_controls.language.current == opt.value %}selected{% endif %}>
                    {{ opt.label }}
                  </option>
                {% endfor %}
              </select>
            {% elif rw_language %}
              {{ rw_language.name|default:"English"|slice:":3"|upper }}{% if rw_language.variant %}/{{ rw_language.variant|slice:":3"|upper }}{% else %}/AUTO{% endif %}
            {% else %}
              {% with p=request.user.profile %}
                {{ p.default_language|default:"English"|slice:":3"|upper }}/{{ p.default_language_variant|default:"British English"|slice:":3"|upper }}
              {% endwith %}
            {% endif %}
          </div>
        </div>

        {# ---------- V2 AVATAR TILES (CANONICAL) ---------- #}
        <div class="rw-status {% if rw_topbar_controls.enabled and rw_topbar_controls.axes.tone.overridden %}rw-status--overridden{% endif %}">
          <div class="rw-status-label">Tone</div>
          <div class="rw-status-value">
            {% if rw_topbar_controls.enabled %}
              <select class="rw-status-select rw-topbar-select"
                      data-axis="tone"
                      aria-label="Tone override">
                <option value="" {% if not rw_topbar_controls.axes.tone.current %}selected{% endif %}>
                  {% if rw_v2 %}{{ rw_v2.tone }}{% else %}-{% endif %}
                </option>
                {% for opt in rw_topbar_controls.axes.tone.choices %}
                  <option value="{{ opt.id }}" {% if rw_topbar_controls.axes.tone.current == opt.id %}selected{% endif %}>{{ opt.name }}</option>
                {% endfor %}
              </select>
            {% else %}
              {% if rw_v2 %}{{ rw_v2.tone }}{% else %}—{% endif %}
            {% endif %}
          </div>
        </div>

        <div class="rw-status {% if rw_topbar_controls.enabled and rw_topbar_controls.axes.reasoning.overridden %}rw-status--overridden{% endif %}">
          <div class="rw-status-label">Reasoning</div>
          <div class="rw-status-value">
            {% if rw_topbar_controls.enabled %}
              <select class="rw-status-select rw-topbar-select"
                      data-axis="reasoning"
                      aria-label="Reasoning override">
                <option value="" {% if not rw_topbar_controls.axes.reasoning.current %}selected{% endif %}>
                  {% if rw_v2 %}{{ rw_v2.reasoning }}{% else %}-{% endif %}
                </option>
                {% for opt in rw_topbar_controls.axes.reasoning.choices %}
                  <option value="{{ opt.id }}" {% if rw_topbar_controls.axes.reasoning.current == opt.id %}selected{% endif %}>{{ opt.name }}</option>
                {% endfor %}
              </select>
            {% else %}
              {% if rw_v2 %}{{ rw_v2.reasoning }}{% else %}—{% endif %}
            {% endif %}
          </div>
        </div>

        <div class="rw-status {% if rw_topbar_controls.enabled and rw_topbar_controls.axes.approach.overridden %}rw-status--overridden{% endif %}">
          <div class="rw-status-label">Approach</div>
          <div class="rw-status-value">
            {% if rw_topbar_controls.enabled %}
              <select class="rw-status-select rw-topbar-select"
                      data-axis="approach"
                      aria-label="Approach override">
                <option value="" {% if not rw_topbar_controls.axes.approach.current %}selected{% endif %}>
                  {% if rw_v2 %}{{ rw_v2.approach }}{% else %}-{% endif %}
                </option>
                {% for opt in rw_topbar_controls.axes.approach.choices %}
                  <option value="{{ opt.id }}" {% if rw_topbar_controls.axes.approach.current == opt.id %}selected{% endif %}>{{ opt.name }}</option>
                {% endfor %}
              </select>
            {% else %}
              {% if rw_v2 %}{{ rw_v2.approach }}{% else %}—{% endif %}
            {% endif %}
          </div>
        </div>

        <div class="rw-status {% if rw_topbar_controls.enabled and rw_topbar_controls.axes.control.overridden %}rw-status--overridden{% endif %}">
          <div class="rw-status-label">Control</div>
          <div class="rw-status-value">
            {% if rw_topbar_controls.enabled %}
              <select class="rw-status-select rw-topbar-select"
                      data-axis="control"
                      aria-label="Control override">
                <option value="" {% if not rw_topbar_controls.axes.control.current %}selected{% endif %}>
                  {% if rw_v2 %}{{ rw_v2.control }}{% else %}-{% endif %}
                </option>
                {% for opt in rw_topbar_controls.axes.control.choices %}
                  <option value="{{ opt.id }}" {% if rw_topbar_controls.axes.control.current == opt.id %}selected{% endif %}>{{ opt.name }}</option>
                {% endfor %}
              </select>
            {% else %}
              {% if rw_v2 %}{{ rw_v2.control }}{% else %}—{% endif %}
            {% endif %}
          </div>
        </div>

        {# --- Row break: bottom row is Project, Chat, Current Turn --- #}
        <div class="rw-break" aria-hidden="true"></div>

        {# BOTTOM ROW: Project Mode + Name #}
        <div class="rw-status rw-status-project">
          <div class="rw-status-label">&nbsp;</div>
          <div class="rw-status-value">
            {% if rw_projects and rw_projects.active %}
              {% if rw_projects.active.kind == "SANDBOX" %}
                <span class="text-warning fw-semibold" style="font-size:.7rem;" title="Sandbox">Sandbox</span>
              {% else %}
                <span class="text-success fw-semibold" style="font-size:.7rem;" title="Controlled">Controlled</span>
              {% endif %}
              <div class="rw-status-value" title="{{ rw_projects.active.name }}">
                {{ rw_projects.active.name }}
              </div>
            {% else %}
              —
            {% endif %}
          </div>
        </div>

        {# BOTTOM ROW: Chat #}
        <div class="rw-status">
          <div class="rw-status-label">Chat</div>
          <div class="rw-status-value">
            {% if rw_chat and rw_chat.chat_title %}
              <div class="rw-status-value" title="{{ rw_chat.chat_title }}">
                {{ rw_chat.chat_title }}
              </div>
            {% else %}
              —
            {% endif %}
          </div>
        </div>

        {# BOTTOM ROW: Turns Since Summary #}
        <div class="rw-status">
          <div class="rw-status-label">Since Summary</div>
          <div class="rw-status-value">
            {% if rw_chat %}
              {{ rw_chat.turn_count|default:0 }}
            {% else %}
              0
            {% endif %}
          </div>
        </div>

        {# BOTTOM ROW: Active Model #}
        <div class="rw-status">
          <div class="rw-status-label">Model</div>
          <div class="rw-status-value">
            {% if rw_llm_model %}
              <span class="badge text-bg-light border">{{ rw_llm_model }}</span>
            {% else %}
              —
            {% endif %}
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: Actions (stacked, compact) -->
    <div class="rw-topbar-right rw-topbar-actions">

        <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs rw-bell-btn rw-bell-icon"
           href="{% url 'notifications:list' %}"
           aria-label="Notifications">
            🔔
            {% if rw_notifications and rw_notifications.unread_count %}
            <span class="rw-bell-badge">{{ rw_notifications.unread_count }}</span>
            {% endif %}
        </a>

        <button class="btn btn-outline-primary rw-topbar-btn rw-btn-xs"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#rwHelp"
                aria-controls="rwHelp"
                aria-label="Help">
            Help
        </button>

        <form action="{% url 'accounts:logout' %}" method="post" class="rw-inline-form">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs">
                Logout
            </button>
        </form>

        <!--{% if request.user.is_superuser %}
        <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs" href="/admin/">
            Admin
        </a>
        {% endif %}-->
    </div>

</header>

{% include "partials/rw_help_offcanvas.html" %}

{% if rw_topbar_controls.enabled %}
<script>
(function () {
  var selects = document.querySelectorAll(".rw-topbar-select[data-axis]");
  if (!selects.length) return;

  function getCsrfToken() {
    var parts = ("; " + document.cookie).split("; csrftoken=");
    if (parts.length < 2) return "";
    return parts.pop().split(";").shift();
  }

  var endpoint = "{% url 'accounts:session_overrides_update' %}";

  function setTileHighlight(select) {
    var tile = select.closest(".rw-status");
    if (!tile) return;
    tile.classList.toggle("rw-status--overridden", !!String(select.value || "").trim());
  }

  selects.forEach(function (select) {
    var previous = select.value;
    select.addEventListener("focus", function () {
      previous = select.value;
    });
    select.addEventListener("change", function () {
      var payload = {
        axis: select.getAttribute("data-axis") || "",
        value: select.value || "",
        chat_id: "{{ active_chat.id|default:'' }}"
      };

      select.disabled = true;
      fetch(endpoint, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken()
        },
        body: JSON.stringify(payload)
      })
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        if (!data || !data.ok) {
          throw new Error((data && data.error) ? data.error : "Override update failed.");
        }
        setTileHighlight(select);
      })
      .catch(function (err) {
        select.value = previous;
        alert("Override update failed: " + (err && err.message ? err.message : String(err)));
      })
      .finally(function () {
        select.disabled = false;
      });
    });
  });
})();
</script>
{% endif %}
