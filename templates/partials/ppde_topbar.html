{# -*- coding: utf-8 -*- #}
{# templates/partials/ppde_topbar.html #}

<div class="rw-topbar d-flex align-items-center justify-content-between px-3 py-2 position-relative"
     style="border-bottom:1px solid rgba(0,0,0,0.08); background:#fafafa;">
  <div class="d-flex flex-wrap align-items-center gap-2" >
    <i class="bi bi-diagram-3"></i>
    <div>
      <div class="fw-semibold">Project Planning</div>
      <div class="small text-secondary">
        {% if project %}{{ project.name }}{% else %}PPDE{% endif %}
      </div>
    </div>
    <div class="ms-3 small text-secondary">
      {{ request.user.username }} â€”
      {% if ppde_can_commit %}
        Committer
      {% elif request.user.is_authenticated %}
        Contributor
      {% else %}
        Viewer
      {% endif %}
      {% if ppde_can_commit and not ppde_progress.all_locked %}
        <div class="text-muted">Finalise available after Verify/Propose.</div>
      {% endif %}
    </div>
    {% if ppde_status_badge %}
      <span class="badge {{ ppde_status_badge.class }}" title="{{ ppde_status_badge.text }}">{{ ppde_status_badge.text }}</span>
    {% endif %}
  </div>


  <div class="d-flex flex-wrap align-items-center gap-2" >
    <button class="btn btn-sm btn-success rw-topbar-btn rw-btn-xs"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#rwPpdeHelp"
            aria-controls="rwPpdeHelp">
      Help
    </button>

    <form method="post" class="m-0 d-inline">
      {% csrf_token %}
      <input type="hidden" name="action" value="stage_add" />
      <button type="submit" class="btn btn-sm rw-topbar-btn rw-btn-xs" style="background-color:#3b82f6; border-color:#3b82f6; color:#fff;">Add stage</button>
    </form>

    {% if not ppde_progress.all_locked %}
      <form method="post" class="m-0 d-inline">
        {% csrf_token %}
        <input type="hidden" name="action" value="verify_propose_all" />
        <button type="submit" class="btn btn-sm btn-primary rw-topbar-btn rw-btn-xs">
          Verify/Propose
        </button>
      </form>
    {% endif %}

    {% if ppde_can_commit and ppde_progress.all_locked %}
      <form method="post" class="m-0 d-inline">
        {% csrf_token %}
        <input type="hidden" name="action" value="finalise_pdo" />
        <button type="submit" class="btn btn-sm btn-success rw-topbar-btn rw-btn-xs">Finalise PDO</button>
      </form>
    {% endif %}

    <button type="button" class="btn btn-sm btn-secondary rw-topbar-btn rw-btn-xs" id="ppdeSaveExitBtn" onclick="return window.ppdeSaveExit && window.ppdeSaveExit();">
      Save &amp; exit
    </button>

    {% if ui_return_to %}
      <a class="btn btn-sm btn-secondary rw-topbar-btn rw-btn-xs" href="{{ ui_return_to }}">Exit PPDE</a>
    {% endif %}
  </div>
</div>

<!-- PPDE Help offcanvas -->
<div class="offcanvas offcanvas-end rw-pde-help"
     tabindex="-1"
     id="rwPpdeHelp"
     aria-labelledby="rwPpdeHelpLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="rwPpdeHelpLabel">PPDE Help</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column gap-2">

    <div class="small text-secondary">
      Ask questions about planning blocks, wording, and transitions. This does not edit PPDE.
    </div>

    <div class="rw-pde-help-log border rounded p-2 bg-white">
      {% if ppde_help_log %}
        {% for m in ppde_help_log %}
          <div class="mb-2">
            <div class="fw-semibold" style="font-size:0.8rem;">
              {% if m.role == "user" %}You{% else %}Assistant{% endif %}
            </div>
            <div style="white-space:pre-wrap; font-size:0.85rem;">{{ m.text }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-secondary small">No help messages yet.</div>
      {% endif %}
    </div>

    <form method="post" class="mt-auto">
      {% csrf_token %}
      <input type="hidden" name="action" value="help_ask" />
      <div class="mb-2">
        <label class="form-label small mb-1" for="id_ppde_help_question">Question</label>
        <textarea class="form-control" id="id_ppde_help_question" name="help_question" rows="3"
                  placeholder="Type a question..."></textarea>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary rw-topbar-btn rw-btn-xs" type="submit">Ask</button>
        <button class="btn btn-sm btn-outline-secondary" type="submit" name="action" value="help_clear">
          Clear
        </button>
      </div>

      {% if ppde_help_auto_open %}
        <div class="small text-secondary mt-2">
          (Help drawer will reopen after this page refresh.)
        </div>
      {% endif %}
    </form>

  </div>
</div>

{% if ppde_help_auto_open %}
<script>
(function () {
  try {
    var el = document.getElementById("rwPpdeHelp");
    if (el && window.bootstrap) {
      var oc = bootstrap.Offcanvas.getOrCreateInstance(el);
      oc.show();
    }
  } catch (e) {}
})();
</script>
{% endif %}
