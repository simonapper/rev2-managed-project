{# -*- coding: utf-8 -*- #}
{# templates/partials/pde_topbar.html #}

<div class="rw-topbar d-flex align-items-center justify-content-between px-3 py-2 position-relative"
     style="border-bottom:1px solid rgba(0,0,0,0.08); background:#fafafa;">
  <div class="d-flex flex-wrap align-items-center gap-2">
    <i class="bi bi-shield-check"></i>
    <div>
      <div class="fw-semibold">Project Definition</div>
      <div class="small text-secondary">
        {% if project %}{{ project.name }}{% else %}Definition Mode{% endif %}
      </div>
    </div>
    <div class="ms-3 small text-secondary">
      {{ request.user.username }} —
      {% if pde_can_commit %}
        Committer
      {% elif request.user.is_authenticated %}
        Contributor
      {% else %}
        Viewer
      {% endif %}
    </div>
    {% if pde_status_badge %}
      <span class="badge {{ pde_status_badge.class }}">{{ pde_status_badge.text }}</span>
    {% endif %}
  </div>


  <div class="d-flex flex-wrap align-items-center gap-2">

    {# Help Chat button #}
    <button class="btn btn-sm btn-success rw-topbar-btn rw-btn-xs"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#rwPdeHelp"
            aria-controls="rwPdeHelp">
      Help
    </button>

    <!--{# ------------------------------------------------------------
       Action buttons (context dependent)
       Required context vars:
       - pde_has_changes (bool)
       - all_locked (bool)
       - ui_return_to (url)
       ------------------------------------------------------------ #}-->

    {% if not pde_has_changes %}
      {# No changes: view-only PDE; just exit back. #}
      <a class="btn btn-sm btn-secondary rw-topbar-btn rw-btn-xs" href="{{ ui_return_to }}">
        Exit PDE
      </a>

    {% elif not all_locked %}
      {# Changes present and not all locked: save draft or validate+lock. #}
      <form method="post" class="m-0 d-inline">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_exit" />
        <button class="btn btn-sm btn-secondary rw-topbar-btn rw-btn-xs" type="submit">
          Save draft
        </button>
      </form>

      <button class="btn btn-sm rw-pde-validate-btn rw-topbar-btn rw-btn-xs" style="background-color:transparent; border-color:#3b82f6; color:#3b82f6;" type="button">
        Validate and Lock
      </button>
    {% else %}
      {# All locked and changes present: ready to commit new CKO. #}
      {% if pde_can_commit %}
        <form method="post" class="m-0 d-inline">
          {% csrf_token %}
          <input type="hidden" name="action" value="commit" />
          <button class="btn btn-sm btn-success rw-topbar-btn rw-btn-xs" type="submit">
            Commit
          </button>
        </form>
      {% else %}
        <div class="small text-danger">Only the Project Committer can commit this project.</div>
        <button class="btn btn-sm btn-success rw-topbar-btn rw-btn-xs" type="button" disabled>
          Commit
        </button>
      {% endif %}

      <a class="btn btn-sm btn-secondary rw-topbar-btn rw-btn-xs" href="{{ ui_return_to }}">
        Exit PDE
      </a>
    {% endif %}
  </div>
</div>

<!--{# ------------------------------------------------------------
   PDE Help Chat (offcanvas) - non-canonical, session-backed
   ------------------------------------------------------------ #}-->
<div class="offcanvas offcanvas-end rw-pde-help"
     tabindex="-1"
     id="rwPdeHelp"
     aria-labelledby="rwPdeHelpLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="rwPdeHelpLabel">PDE Help</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column gap-2">

    <div class="small text-secondary">
      Ask questions about fields, wording, intent. This does not edit the PDE.
    </div>

    <div class="rw-pde-help-log border rounded p-2 bg-white">
      {% if pde_help_log %}
        {% for m in pde_help_log %}
          <div class="mb-2">
            <div class="fw-semibold" style="font-size:0.8rem;">
              {% if m.role == "user" %}You{% else %}Assistant{% endif %}
            </div>
            <div style="white-space:pre-wrap; font-size:0.85rem;">{{ m.text }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-secondary small">No help messages yet.</div>
      {% endif %}
    </div>

    <form method="post" class="mt-auto">
      {% csrf_token %}
      <input type="hidden" name="action" value="help_ask" />
      <div class="mb-2">
        <label class="form-label small mb-1" for="id_help_question">Question</label>
        <textarea class="form-control" id="id_help_question" name="help_question" rows="3"
                  placeholder="Type a question..."></textarea>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary" type="submit">Ask</button>
        <button class="btn btn-sm btn-secondary rw-topbar-btn rw-btn-xs" type="submit" name="action" value="help_clear">
          Clear
        </button>
      </div>

      {% if pde_help_auto_open %}
        <div class="small text-secondary mt-2">
          (Help drawer will reopen after this page refresh.)
        </div>
      {% endif %}
    </form>

  </div>
</div>

{% if pde_help_auto_open %}
<script>
(function () {
  try {
    var el = document.getElementById("rwPdeHelp");
    if (el && window.bootstrap) {
      var oc = bootstrap.Offcanvas.getOrCreateInstance(el);
      oc.show();
    }
  } catch (e) {}
})();
</script>
{% endif %}
