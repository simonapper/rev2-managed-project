{% extends "base.html" %}
{% load static %}

{% block title %}PPDE â€” {{ project.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  {# inline chat drawer renders inside each section below #}
  <form method="post" id="ppdeSaveAllForm" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="action" value="save_all" />
    <div id="ppdeSaveAllFields"></div>
  </form>
  <div class="row g-3">

    <div class="col-12">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <details open class="mb-0" data-ppde-detail-key="ppde-seed">
            <summary class="fw-semibold">Seeded Context (CKO)</summary>
            <div class="d-flex align-items-center justify-content-between mb-2 mt-2">
              <div></div>
              <div class="d-flex gap-2">
              {% if ppde_can_commit %}
                <form method="post" class="m-0" onsubmit="return confirm('Generate stages from CKO? This will replace current draft stages.');">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="generate_from_cko" />
                  <button class="btn btn-sm btn-outline-primary" type="submit">Generate stages</button>
                </form>
              {% endif %}
              {% if not structure_contract %}
                <div class="small text-muted align-self-center">No active contract set (admin).</div>
              {% endif %}
              <form method="post" class="m-0">
                {% csrf_token %}
                <input type="hidden" name="action" value="seed_toggle" />
                <input type="hidden" name="seed_view" value="{% if seed_view == 'short' %}full{% else %}short{% endif %}" />
                <button class="btn btn-sm btn-outline-secondary" type="submit">
                  {% if seed_view == "short" %}Show full{% else %}Show condensed{% endif %}
                </button>
              </form>
              {% if ppde_can_commit and not seed_has_summary %}
                <form method="post" class="m-0">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="seed_condense" />
                  <button class="btn btn-sm btn-outline-primary" type="submit">Condense</button>
                </form>
              {% endif %}
              </div>
            </div>
          {% if stage_preview %}
            <div class="border rounded p-3 mb-3">
              <div class="d-flex align-items-center justify-content-between">
                <div class="fw-semibold">Stage preview</div>
                <form method="post" class="m-0">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="stage_preview_discard" />
                  <button class="btn btn-sm btn-outline-secondary" type="submit">Discard</button>
                </form>
              </div>
              <div class="small text-muted mt-1">Generated {{ stage_preview.summary.count }} stages.</div>
              <ul class="small mt-2 mb-0">
                {% for item in stage_preview.summary.items %}
                  <li>
                    <span class="fw-semibold">{{ item.title }}</span>
                    {% if item.description %}<div class="text-muted">{{ item.description }}</div>{% endif %}
                  </li>
                {% empty %}
                  <li class="text-muted">No stages in preview.</li>
                {% endfor %}
              </ul>
              <div class="d-flex gap-2 mt-3">
                <form method="post" class="m-0">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="stage_preview_apply" />
                  <input type="hidden" name="apply_mode" value="approve" />
                  <button class="btn btn-sm btn-primary" type="submit">Approve</button>
                </form>
                <form method="post" class="m-0">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="stage_preview_apply" />
                  <input type="hidden" name="apply_mode" value="edit" />
                  <button class="btn btn-sm btn-outline-primary" type="submit">Edit</button>
                </form>
                <button class="btn btn-sm btn-outline-secondary" type="button"
                        data-bs-toggle="offcanvas" data-bs-target="#ppdeStageEdit"
                        aria-controls="ppdeStageEdit">
                  Edit with LLM
                </button>
              </div>
            </div>
          {% endif %}
          {% if seed_context %}
            <ul class="small text-muted mb-0">
              {% for row in seed_context %}
                <li><span class="fw-semibold">{{ row.key }}</span>: {{ row.value }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="small text-muted">No seed snapshot available.</div>
          {% endif %}
          </details>
        </div>
      </div>

      <div class="card shadow-sm mb-3" id="ppde-purpose">
        <div class="card-body">
          <details open class="mb-0" data-ppde-detail-key="ppde-purpose">
            <summary class="fw-semibold">Planning Purpose</summary>
            <div class="d-flex align-items-start justify-content-between gap-3 mt-2">
              <div class="min-w-0">
                <div class="small text-muted mt-1">
                Status:
                <span class="fw-semibold rw-ppde-status" data-block-key="purpose">
                  {% if purpose.status == "PROPOSED" %}
                    PROPOSED{% if purpose.proposed_by %} ({{ purpose.proposed_by }}){% endif %}
                  {% elif purpose.status == "PASS_LOCKED" %}
                    LOCKED{% if purpose.locked_by %} ({{ purpose.locked_by }}){% endif %}
                  {% else %}
                    {{ purpose.status }}
                  {% endif %}
                </span>
              </div>
              </div>
              {% if purpose.status == "DRAFT" or ppde_can_commit %}
                {% if purpose_chat_id %}
                  <a class="btn btn-sm btn-outline-primary"
                     href="?ppde_chat_id={{ purpose_chat_id }}&ppde_chat_open=1#ppde-purpose">Open topic chat</a>
                {% else %}
                  <form method="post" action="{% url 'projects:ppde_topic_chat_open' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="topic_type" value="PURPOSE" />
                    <input type="hidden" name="open_in" value="drawer" />
                    <button class="btn btn-sm btn-outline-primary" type="submit">Topic chat</button>
                  </form>
                {% endif %}
              {% endif %}
            </div>
          <form method="post" class="mt-2">
            {% csrf_token %}
            <input type="hidden" name="block_key" value="purpose" />

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">PDO summary</label>
              <textarea name="pdo_summary"
                        class="form-control"
                        rows="2"
                        data-ppde-block="purpose"
                        data-ppde-field="pdo_summary"
                        {% if purpose.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ purpose.pdo_summary }}</textarea>
            </div>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">CKO alignment: stage 1 inputs match</label>
              <textarea name="cko_alignment_stage1_inputs_match"
                        class="form-control"
                        rows="2"
                        data-ppde-block="purpose"
                        data-ppde-field="cko_alignment_stage1_inputs_match"
                        {% if purpose.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ purpose.cko_alignment_stage1_inputs_match }}</textarea>
            </div>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">CKO alignment: final outputs match</label>
              <textarea name="cko_alignment_final_outputs_match"
                        class="form-control"
                        rows="2"
                        data-ppde-block="purpose"
                        data-ppde-field="cko_alignment_final_outputs_match"
                        {% if purpose.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ purpose.cko_alignment_final_outputs_match }}</textarea>
            </div>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">Planning constraints</label>
              <textarea name="planning_constraints"
                        class="form-control"
                        rows="2"
                        data-ppde-block="purpose"
                        data-ppde-field="planning_constraints"
                        {% if purpose.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ purpose.planning_constraints }}</textarea>
            </div>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">Assumptions</label>
              <textarea name="assumptions"
                        class="form-control"
                        rows="2"
                        data-ppde-block="purpose"
                        data-ppde-field="assumptions"
                        {% if purpose.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ purpose.assumptions }}</textarea>
            </div>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">Planning purpose</label>
              <textarea name="purpose_text"
                        class="form-control"
                        rows="4"
                        data-ppde-block="purpose"
                        data-ppde-field="purpose_text"
                        {% if purpose.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ purpose.value_text }}</textarea>
            </div>

            <div class="d-flex align-items-center justify-content-between mt-2">
              <div class="small text-muted">Define the intent and scope of the planning workflow.</div>
              <div class="d-flex gap-2">
                {% if purpose.status == "PASS_LOCKED" and ppde_can_commit %}
                  <span class="d-inline-flex gap-2 rw-ppde-lock-controls" data-block-key="purpose">
                    <button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-lock-action" data-action="reopen_block" data-block-key="purpose">Reopen</button>
                  </span>
                {% else %}
                  {% if purpose.status == "DRAFT" or ppde_can_commit %}
                    <button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-block-action" data-action="save_block" data-block-key="purpose">Save Draft</button>
                  {% endif %}
                  {% if ppde_can_commit %}
                    <button type="submit" name="action" value="seed_purpose_from_cko"
                            class="btn btn-sm btn-outline-primary"
                            {% if purpose.value_text %}onclick="return confirm('Planning purpose already exists. Seed from CKO will not overwrite it. Continue?');"{% endif %}>
                      Seed from CKO
                    </button>
                    {% if not structure_contract %}
                      <div class="small text-muted align-self-center">No active contract set (admin).</div>
                    {% endif %}
                  {% endif %}
                  <button type="button" class="btn btn-sm btn-outline-primary rw-ppde-block-action" data-action="verify_block" data-block-key="purpose">Verify</button>
                  {% if not transform_contract %}
                    <div class="small text-muted align-self-center">No active contract set (admin).</div>
                  {% endif %}
                  <span class="d-inline-flex gap-2 rw-ppde-lock-controls" data-block-key="purpose">
                    {% if purpose.status == "DRAFT" %}
                      <button type="button" class="btn btn-sm btn-outline-primary rw-ppde-lock-action" data-action="propose_lock" data-block-key="purpose">Propose Lock</button>
                    {% endif %}
                    {% if purpose.status == "PROPOSED" and ppde_can_commit %}
                      <button type="button" class="btn btn-sm btn-success rw-ppde-lock-action" data-action="approve_lock" data-block-key="purpose">Approve Lock</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-lock-action" data-action="reopen_block" data-block-key="purpose">Reopen</button>
                    {% endif %}
                  </span>
                {% endif %}
              </div>
            </div>
          </form>

          <div id="ppde-validation-purpose">
            {% if purpose.last_validation and show_validation_key == "purpose" %}
              {% if purpose.last_validation.issues %}
                <div class="mt-2 text-danger small">
                  <div class="fw-semibold">Issues</div>
                  <ul class="mb-0">
                    {% for it in purpose.last_validation.issues %}
                      <li>{{ it }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              {% if purpose.last_validation.questions %}
                <div class="mt-2 small">
                  <div class="fw-semibold">Questions</div>
                  <ul class="mb-0">
                    {% for q in purpose.last_validation.questions %}
                      <li>{{ q }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              {% if purpose.last_validation.suggested_revision %}
                <div class="mt-2 small">
                  <div class="fw-semibold">Suggested revision</div>
                  <div style="white-space:pre-wrap;">{{ purpose.last_validation.suggested_revision }}</div>
                </div>
              {% endif %}
            {% endif %}
          </div>
          {% include "projects/ppde_inline_chat.html" with chat_ctx=purpose_chat_ctx %}
          </details>
        </div>
      </div>

      {% for stage in stages %}
        <div class="card shadow-sm mb-3" id="ppde-stage-{{ stage.id }}">
          <div class="card-body">
            <details open class="mb-0" data-ppde-detail-key="ppde-stage-{{ stage.id }}">
              <summary class="fw-semibold">Stage {{ stage.order_index }}</summary>
              <div class="d-flex align-items-start justify-content-between gap-3 mt-2">
                <div class="min-w-0">
                  <div class="small text-muted mt-1">
                Status:
                <span class="fw-semibold rw-ppde-status" data-block-key="stage:{{ stage.id }}">
                  {% if stage.status == "PROPOSED" %}
                    PROPOSED{% if stage.proposed_by %} ({{ stage.proposed_by }}){% endif %}
                    {% elif stage.status == "PASS_LOCKED" %}
                      LOCKED{% if stage.locked_by %} ({{ stage.locked_by }}){% endif %}
                    {% else %}
                      {{ stage.status }}
                    {% endif %}
                  </span>
                </div>
                </div>
                <div class="d-flex gap-2">
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="stage_move_up" />
                  <input type="hidden" name="block_key" value="stage:{{ stage.id }}" />
                  <button class="btn btn-sm btn-outline-secondary" type="submit">Move up</button>
                </form>
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="stage_move_down" />
                  <input type="hidden" name="block_key" value="stage:{{ stage.id }}" />
                  <button class="btn btn-sm btn-outline-secondary" type="submit">Move down</button>
                </form>
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="stage_duplicate" />
                  <input type="hidden" name="block_key" value="stage:{{ stage.id }}" />
                  <button class="btn btn-sm btn-outline-secondary" type="submit">Duplicate</button>
                </form>
                {% if stage.status == "DRAFT" or ppde_can_commit %}
                  {% if stage.topic_chat_id %}
                    <a class="btn btn-sm btn-outline-primary"
                       href="?ppde_chat_id={{ stage.topic_chat_id }}&ppde_chat_open=1#ppde-stage-{{ stage.id }}">Open topic chat</a>
                  {% else %}
                    <form method="post" action="{% url 'projects:ppde_topic_chat_open' project.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="topic_type" value="STAGE" />
                      <input type="hidden" name="stage_id" value="{{ stage.id }}" />
                      <input type="hidden" name="open_in" value="drawer" />
                      <button class="btn btn-sm btn-outline-primary" type="submit">Topic chat</button>
                    </form>
                  {% endif %}
                {% endif %}
                {% if ppde_can_commit %}
                  <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="stage_delete" />
                    <input type="hidden" name="block_key" value="stage:{{ stage.id }}" />
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                {% endif %}
              </div>
            </div>
            <form method="post" class="mt-2">
              {% csrf_token %}
              <input type="hidden" name="block_key" value="stage:{{ stage.id }}" />

              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Title</label>
                  <input type="text" name="title" class="form-control"
                         data-ppde-block="stage"
                         data-stage-id="{{ stage.id }}"
                         data-ppde-field="title"
                         value="{{ stage.title }}"
                         {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %} />
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Purpose</label>
                  <textarea name="purpose" class="form-control" rows="2"
                            data-ppde-block="stage"
                            data-stage-id="{{ stage.id }}"
                            data-ppde-field="purpose"
                            {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ stage.purpose }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Inputs (material known at the start)</label>
                  <textarea name="inputs" class="form-control" rows="2"
                            data-ppde-block="stage"
                            data-stage-id="{{ stage.id }}"
                            data-ppde-field="inputs"
                            {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ stage.inputs }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Stage process (1-3 sentences: how inputs become outputs)</label>
                  <textarea name="stage_process" class="form-control" rows="2"
                            data-ppde-block="stage"
                            data-stage-id="{{ stage.id }}"
                            data-ppde-field="stage_process"
                            {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ stage.stage_process }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Outputs (one per line; feed the next stage)</label>
                  <textarea name="outputs" class="form-control" rows="3"
                            data-ppde-block="stage"
                            data-stage-id="{{ stage.id }}"
                            data-ppde-field="outputs"
                            {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ stage.outputs }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Assumptions (optional)</label>
                  <textarea name="assumptions" class="form-control" rows="2"
                            data-ppde-block="stage"
                            data-stage-id="{{ stage.id }}"
                            data-ppde-field="assumptions"
                            {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ stage.assumptions }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Duration Estimate</label>
                  <textarea name="duration_estimate" class="form-control" rows="2"
                            data-ppde-block="stage"
                            data-stage-id="{{ stage.id }}"
                            data-ppde-field="duration_estimate"
                            {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ stage.duration_estimate }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label small text-muted mb-1">Risks / Notes</label>
                  <textarea name="risks_notes" class="form-control" rows="2"
                            data-ppde-block="stage"
                            data-stage-id="{{ stage.id }}"
                            data-ppde-field="risks_notes"
                            {% if stage.status != "DRAFT" and not ppde_can_commit %}readonly{% endif %}>{{ stage.risks_notes }}</textarea>
                </div>
              </div>

              <div class="d-flex align-items-center justify-content-between mt-3">
                <div class="small text-muted">Lock when this stage definition is complete.</div>
                <div class="d-flex gap-2">
                  {% if stage.status == "PASS_LOCKED" and ppde_can_commit %}
                    <span class="d-inline-flex gap-2 rw-ppde-lock-controls" data-block-key="stage:{{ stage.id }}">
                      <button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-lock-action" data-action="reopen_block" data-block-key="stage:{{ stage.id }}">Reopen</button>
                    </span>
                  {% else %}
                    {% if stage.status == "DRAFT" or ppde_can_commit %}
                      <button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-block-action" data-action="save_block" data-block-key="stage:{{ stage.id }}">Save Draft</button>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-outline-primary rw-ppde-block-action" data-action="verify_block" data-block-key="stage:{{ stage.id }}">Verify</button>
                    {% if transform_contract %}
                      <button class="btn btn-sm btn-outline-secondary" type="button"
                              data-bs-toggle="modal" data-bs-target="#ppdeTransformContract">
                        View contract
                      </button>
                    {% else %}
                      <div class="small text-muted align-self-center">No active contract set (admin).</div>
                    {% endif %}
                    <span class="d-inline-flex gap-2 rw-ppde-lock-controls" data-block-key="stage:{{ stage.id }}">
                      {% if stage.status == "DRAFT" %}
                        <button type="button" class="btn btn-sm btn-outline-primary rw-ppde-lock-action" data-action="propose_lock" data-block-key="stage:{{ stage.id }}">Propose Lock</button>
                      {% endif %}
                      {% if stage.status == "PROPOSED" and ppde_can_commit %}
                        <button type="button" class="btn btn-sm btn-success rw-ppde-lock-action" data-action="approve_lock" data-block-key="stage:{{ stage.id }}">Approve Lock</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-lock-action" data-action="reopen_block" data-block-key="stage:{{ stage.id }}">Reopen</button>
                      {% endif %}
                    </span>
                  {% endif %}
                </div>
              </div>
            </form>

            {% include "projects/ppde_inline_chat.html" with chat_ctx=stage.topic_chat_ctx %}

            <div class="text-muted small mt-2">
              Execution planning is produced in MDE, not PPDE.
            </div>

            <div id="ppde-validation-stage-{{ stage.id }}">
              {% if stage.last_validation and show_validation_key == stage.validation_key %}
                {% if stage.last_validation.issues %}
                  <div class="mt-2 text-danger small">
                    <div class="fw-semibold">Issues</div>
                    <ul class="mb-0">
                      {% for it in stage.last_validation.issues %}
                        <li>{{ it }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
                {% if stage.last_validation.questions %}
                  <div class="mt-2 small">
                    <div class="fw-semibold">Questions</div>
                    <ul class="mb-0">
                      {% for q in stage.last_validation.questions %}
                        <li>{{ q }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
                {% if stage.last_validation.suggested_revision %}
                  <div class="mt-2 small">
                    <div class="fw-semibold">Suggested revision</div>
                    <div style="white-space:pre-wrap;">{{ stage.last_validation.suggested_revision }}</div>
                  </div>
                {% endif %}
              {% endif %}
            </div>
            </details>
          </div>
        </div>
      {% endfor %}

      {# Plan / execution / WKO surfaces removed: PPDE is PDO-only #}
    </div>
  <script>
  (function () {
    var form = document.getElementById("ppdeSaveAllForm");
    var fieldsHost = document.getElementById("ppdeSaveAllFields");
    if (!form || !fieldsHost) return;

    function clearDynamicFields() {
      while (fieldsHost.firstChild) {
        fieldsHost.removeChild(fieldsHost.firstChild);
      }
    }

    function addHidden(name, value) {
      var input = document.createElement("input");
      input.type = "hidden";
      input.name = name;
      input.value = value || "";
      fieldsHost.appendChild(input);
    }

    window.ppdeSaveExit = function () {
      clearDynamicFields();
      addHidden("exit", "1");

      var purposeFields = [
        "pdo_summary",
        "cko_alignment_stage1_inputs_match",
        "cko_alignment_final_outputs_match",
        "planning_constraints",
        "assumptions",
        "purpose_text"
      ];
      purposeFields.forEach(function (key) {
        var el = document.querySelector("[data-ppde-block='purpose'][data-ppde-field='" + key + "']");
        if (el) {
          addHidden(key, el.value || "");
        }
      });

      var stageFields = document.querySelectorAll("[data-ppde-block='stage'][data-stage-id][data-ppde-field]");
      stageFields.forEach(function (el) {
        var sid = el.getAttribute("data-stage-id") || "";
        var field = el.getAttribute("data-ppde-field") || "";
        if (!sid || !field) return;
        var name = "stage_" + sid + "__" + field;
        addHidden(name, el.value || "");
      });

      form.submit();
      return false;
    };
  })();
  </script>

  <script>
  (function () {
    var key = "ppde_scroll_" + "{{ project.id }}";
    if (window.location.hash) {
      return;
    }
    var saved = sessionStorage.getItem(key);
    if (saved !== null) {
      var y = parseInt(saved, 10);
      if (!isNaN(y)) {
        window.scrollTo(0, y);
      }
    }

    var forms = document.querySelectorAll("form");
    forms.forEach(function (f) {
      f.addEventListener("submit", function () {
        sessionStorage.setItem(key, String(window.scrollY || 0));
      });
    });
  })();
  </script>

  <script>
  (function () {
    var storageKey = "ppde_details_" + "{{ project.id }}";
    var details = document.querySelectorAll("details[data-ppde-detail-key]");
    if (!details.length) return;

    var saved = {};
    try {
      saved = JSON.parse(localStorage.getItem(storageKey) || "{}");
    } catch (e) {
      saved = {};
    }

    details.forEach(function (el) {
      var k = el.getAttribute("data-ppde-detail-key");
      if (!k) return;
      if (Object.prototype.hasOwnProperty.call(saved, k)) {
        el.open = !!saved[k];
      }
      el.addEventListener("toggle", function () {
        saved[k] = !!el.open;
        try {
          localStorage.setItem(storageKey, JSON.stringify(saved));
        } catch (e) {}
      });
    });
  })();
  </script>

</div>
{% if structure_contract %}
<div class="modal fade" id="ppdeStructureContract" tabindex="-1" aria-labelledby="ppdeStructureContractLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ppdeStructureContractLabel">{{ structure_contract.title }} (v{{ structure_contract.version }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="small text-muted mb-2">Key: {{ structure_contract.key }}</div>
        <div class="mb-2"><div class="fw-semibold">Purpose</div><div style="white-space:pre-wrap;">{{ structure_contract.purpose_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Inputs</div><div style="white-space:pre-wrap;">{{ structure_contract.inputs_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Outputs</div><div style="white-space:pre-wrap;">{{ structure_contract.outputs_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Method guidance</div><div style="white-space:pre-wrap;">{{ structure_contract.method_guidance_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Acceptance test</div><div style="white-space:pre-wrap;">{{ structure_contract.acceptance_test_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">LLM review prompt</div><div style="white-space:pre-wrap;">{{ structure_contract.llm_review_prompt_text }}</div></div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if transform_contract %}
<div class="modal fade" id="ppdeTransformContract" tabindex="-1" aria-labelledby="ppdeTransformContractLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ppdeTransformContractLabel">{{ transform_contract.title }} (v{{ transform_contract.version }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="small text-muted mb-2">Key: {{ transform_contract.key }}</div>
        <div class="mb-2"><div class="fw-semibold">Purpose</div><div style="white-space:pre-wrap;">{{ transform_contract.purpose_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Inputs</div><div style="white-space:pre-wrap;">{{ transform_contract.inputs_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Outputs</div><div style="white-space:pre-wrap;">{{ transform_contract.outputs_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Method guidance</div><div style="white-space:pre-wrap;">{{ transform_contract.method_guidance_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">Acceptance test</div><div style="white-space:pre-wrap;">{{ transform_contract.acceptance_test_text }}</div></div>
        <div class="mb-2"><div class="fw-semibold">LLM review prompt</div><div style="white-space:pre-wrap;">{{ transform_contract.llm_review_prompt_text }}</div></div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Stage edit offcanvas -->
<div class="offcanvas offcanvas-end rw-pde-help"
     tabindex="-1"
     id="ppdeStageEdit"
     aria-labelledby="ppdeStageEditLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="ppdeStageEditLabel">Stage Preview Editor</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column gap-2">
    <div class="small text-secondary">
      Refine the stage preview with natural language. Each response updates the preview only.
    </div>

    {% if stage_preview %}
      <div class="border rounded p-2 bg-white">
        <div class="fw-semibold small mb-1">Current preview (titles + outputs)</div>
        <ul class="small mb-0">
          {% for item in stage_preview.stages %}
            <li class="mb-1">
              <span class="fw-semibold">{{ item.title|default:"(untitled)" }}</span>
              {% if item.outputs %}
                <div class="text-muted">Outputs: {{ item.outputs }}</div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="rw-pde-help-log border rounded p-2 bg-white">
      {% if stage_edit_log %}
        {% for m in stage_edit_log %}
          <div class="mb-2">
            <div class="fw-semibold" style="font-size:0.8rem;">
              {% if m.role == "user" %}You{% else %}Assistant{% endif %}
            </div>
            <div style="white-space:pre-wrap; font-size:0.85rem;">{{ m.text }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-secondary small">No edit messages yet.</div>
      {% endif %}
    </div>

    <form method="post" class="mt-auto">
      {% csrf_token %}
      <input type="hidden" name="action" value="stage_edit_ask" />
      <div class="mb-2">
        <label class="form-label small mb-1" for="id_ppde_stage_edit_question">Request</label>
        <textarea class="form-control" id="id_ppde_stage_edit_question" name="stage_edit_question" rows="3"
                  placeholder="e.g., merge stages 2 and 3; shorten titles; add a compliance stage..."></textarea>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary" type="submit">Ask</button>
      </div>

      {% if stage_edit_auto_open %}
        <div class="small text-secondary mt-2">
          (Editor will reopen after this page refresh.)
        </div>
      {% endif %}
    </form>

    <form method="post" class="mt-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="stage_edit_clear" />
      <button class="btn btn-sm btn-outline-secondary" type="submit">Close &amp; clear</button>
    </form>
  </div>
</div>

{% if stage_edit_auto_open %}
<script>
(function () {
  try {
    var el = document.getElementById("ppdeStageEdit");
    if (el && window.bootstrap) {
      var oc = bootstrap.Offcanvas.getOrCreateInstance(el);
      oc.show();
    }
  } catch (e) {}
})();
</script>
{% endif %}

<script>
(function () {
  var btn = document.getElementById("ppdeSaveExitBtn");
  var form = document.getElementById("ppdeSaveAllForm");
  var fieldsHost = document.getElementById("ppdeSaveAllFields");
  if (!btn || !form || !fieldsHost) return;

  function clearDynamicFields() {
    while (fieldsHost.firstChild) {
      fieldsHost.removeChild(fieldsHost.firstChild);
    }
  }

  function addHidden(name, value) {
    var input = document.createElement("input");
    input.type = "hidden";
    input.name = name;
    input.value = value || "";
    fieldsHost.appendChild(input);
  }

  btn.addEventListener("click", function () {
    clearDynamicFields();
    addHidden("exit", "1");

    var purposeFields = [
      "pdo_summary",
      "cko_alignment_stage1_inputs_match",
      "cko_alignment_final_outputs_match",
      "planning_constraints",
      "assumptions",
      "purpose_text"
    ];
    purposeFields.forEach(function (key) {
      var el = document.querySelector("[data-ppde-block='purpose'][data-ppde-field='" + key + "']");
      if (el) {
        addHidden(key, el.value || "");
      }
    });

    var stageFields = document.querySelectorAll("[data-ppde-block='stage'][data-stage-id][data-ppde-field]");
    stageFields.forEach(function (el) {
      var sid = el.getAttribute("data-stage-id") || "";
      var field = el.getAttribute("data-ppde-field") || "";
      if (!sid || !field) return;
      var name = "stage_" + sid + "__" + field;
      addHidden(name, el.value || "");
    });

    form.submit();
  });
})();
</script>

<script>
(function () {
  var canCommit = {% if ppde_can_commit %}true{% else %}false{% endif %};

  function escHtml(text) {
    return String(text || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function validationHtml(v) {
    if (!v || typeof v !== "object") return "";
    var html = "";
    var issues = Array.isArray(v.issues) ? v.issues : [];
    var qs = Array.isArray(v.questions) ? v.questions : [];
    var sugg = String(v.suggested_revision || "");
    if (issues.length) {
      html += '<div class="mt-2 text-danger small"><div class="fw-semibold">Issues</div><ul class="mb-0">';
      issues.forEach(function (it) { html += "<li>" + escHtml(it) + "</li>"; });
      html += "</ul></div>";
    }
    if (qs.length) {
      html += '<div class="mt-2 small"><div class="fw-semibold">Questions</div><ul class="mb-0">';
      qs.forEach(function (q) { html += "<li>" + escHtml(q) + "</li>"; });
      html += "</ul></div>";
    }
    if (sugg) {
      html += '<div class="mt-2 small"><div class="fw-semibold">Suggested revision</div><div style="white-space:pre-wrap;">' + escHtml(sugg) + "</div></div>";
    }
    return html;
  }

  function noticeHost() {
    var host = document.getElementById("ppde-ajax-notice");
    if (host) return host;
    var root = document.querySelector(".container-fluid.py-4");
    if (!root) return null;
    host = document.createElement("div");
    host.id = "ppde-ajax-notice";
    host.className = "mb-2";
    root.insertBefore(host, root.firstChild);
    return host;
  }

  function showNotice(text, ok) {
    var host = noticeHost();
    if (!host) return;
    var cls = ok ? "alert-success" : "alert-danger";
    host.innerHTML = '<div class="alert ' + cls + ' py-1 px-2 small mb-0">' + escHtml(text || "") + "</div>";
    setTimeout(function () {
      if (host) host.innerHTML = "";
    }, 2000);
  }

  function statusText(status, actor) {
    if (status === "PASS_LOCKED") return "LOCKED" + (actor ? " (" + actor + ")" : "");
    if (status === "PROPOSED") return "PROPOSED" + (actor ? " (" + actor + ")" : "");
    return "DRAFT";
  }

  function lockButtonsHtml(blockKey, status) {
    if (status === "PASS_LOCKED") {
      if (!canCommit) return "";
      return '<button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-lock-action" data-action="reopen_block" data-block-key="' + blockKey + '">Reopen</button>';
    }
    if (status === "PROPOSED") {
      if (!canCommit) return "";
      return ''
        + '<button type="button" class="btn btn-sm btn-success rw-ppde-lock-action" data-action="approve_lock" data-block-key="' + blockKey + '">Approve Lock</button>'
        + '<button type="button" class="btn btn-sm btn-outline-secondary rw-ppde-lock-action" data-action="reopen_block" data-block-key="' + blockKey + '">Reopen</button>';
    }
    return '<button type="button" class="btn btn-sm btn-outline-primary rw-ppde-lock-action" data-action="propose_lock" data-block-key="' + blockKey + '">Propose Lock</button>';
  }

  function setReadOnlyForBlock(form, status) {
    if (!form || canCommit) return;
    var readonly = status !== "DRAFT";
    var fields = form.querySelectorAll("input[type='text'], textarea");
    fields.forEach(function (el) {
      if (readonly) {
        el.setAttribute("readonly", "");
      } else {
        el.removeAttribute("readonly");
      }
    });
  }

  document.addEventListener("click", function (ev) {
    var btn = ev.target && ev.target.closest ? ev.target.closest(".rw-ppde-lock-action, .rw-ppde-block-action") : null;
    if (!btn) return;
    ev.preventDefault();
    var action = btn.getAttribute("data-action") || "";
    var blockKey = btn.getAttribute("data-block-key") || "";
    var form = btn.closest("form");
    if (!action || !blockKey || !form) return;

    var fd = new FormData(form);
    fd.set("action", action);
    fd.set("block_key", blockKey);
    var body = new URLSearchParams();
    fd.forEach(function (v, k) { body.append(k, String(v || "")); });

    var prior = btn.textContent;
    btn.disabled = true;
    btn.textContent = "Saving...";

    fetch(window.location.pathname, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: body.toString()
    })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      if (!data || !data.ok) {
        showNotice((data && data.message) || "Action failed.", false);
        return;
      }
      var effectiveBlockKey = data.block_key || blockKey;
      var status = data.status || "DRAFT";
      var actor = data.locked_by || data.proposed_by || "";
      var statusEl = document.querySelector(".rw-ppde-status[data-block-key='" + effectiveBlockKey + "']");
      if (statusEl) statusEl.textContent = statusText(status, actor);
      var controls = document.querySelector(".rw-ppde-lock-controls[data-block-key='" + effectiveBlockKey + "']");
      if (controls) controls.innerHTML = lockButtonsHtml(effectiveBlockKey, status);
      setReadOnlyForBlock(form, status);
      if (action === "verify_block" && data.validation) {
        if (effectiveBlockKey === "purpose") {
          var p = document.getElementById("ppde-validation-purpose");
          if (p) p.innerHTML = validationHtml(data.validation);
        } else if (effectiveBlockKey.indexOf("stage:") === 0) {
          var sid = effectiveBlockKey.split(":")[1] || "";
          var s = document.getElementById("ppde-validation-stage-" + sid);
          if (s) s.innerHTML = validationHtml(data.validation);
        }
      }
      showNotice(data.message || "Saved.", true);
    })
    .catch(function () {
      showNotice("Action failed.", false);
    })
    .finally(function () {
      if (document.body.contains(btn)) {
        btn.disabled = false;
        btn.textContent = prior;
      }
    });
  });

  var key = "ppde_scroll_" + "{{ project.id }}";
  if (window.location.hash) {
    return;
  }
  var saved = sessionStorage.getItem(key);
  if (saved !== null) {
    var y = parseInt(saved, 10);
    if (!isNaN(y)) {
      window.scrollTo(0, y);
    }
    sessionStorage.removeItem(key);
  }

  var forms = document.querySelectorAll("form");
  forms.forEach(function (f) {
    f.addEventListener("submit", function () {
      sessionStorage.setItem(key, String(window.scrollY || 0));
    });
  });
})();
</script>

{% endblock %}
