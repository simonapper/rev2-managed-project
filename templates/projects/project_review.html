{% extends "base.html" %}

{% block title %}Project review â€” {{ project.name }}{% endblock %}

{% block content %}
<div class="rw-main-inner">
  <div class="rw-workarea">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex align-items-start justify-content-between gap-3">
          <div class="min-w-0">
            <div class="h5 mb-1">{{ project.name }}</div>
            <div class="small text-muted">Project review</div>
          </div>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <form method="get" class="d-flex flex-wrap gap-2 align-items-center">
              <input type="hidden" name="view" value="{{ intent_view_style }}">
              <input type="hidden" name="apply_seed_controls" value="1">
              <label class="small text-muted mb-0" for="rw-seed-style">Seed style</label>
              <select id="rw-seed-style" class="form-select form-select-sm" name="seed_style" style="min-width: 9rem;">
                <option value="concise" {% if seed_style == "concise" %}selected{% endif %}>Concise</option>
                <option value="balanced" {% if seed_style == "balanced" %}selected{% endif %}>Balanced</option>
                <option value="detailed" {% if seed_style == "detailed" %}selected{% endif %}>Detailed</option>
              </select>
              <input type="text" class="form-control form-control-sm" name="seed_constraints"
                     value="{{ seed_constraints }}" placeholder="Extra constraints"
                     style="min-width: 14rem;">
              <label class="form-check-label small text-muted d-flex align-items-center gap-1 mb-0">
                <input class="form-check-input mt-0" type="checkbox" name="make_default" value="1">
                Make default
              </label>
              <button class="btn btn-sm btn-outline-secondary" type="submit">Apply</button>
            </form>
            {% include "projects/_view_style_toggle.html" %}
            <a class="btn btn-sm btn-outline-secondary"
               href="{% url 'accounts:project_config_info' project.id %}">
              Back to project
            </a>
          </div>
        </div>
      </div>
    </div>

    {% for s in sections %}
      <div class="card shadow-sm mb-3" id="review-{{ s.marker|lower }}">
        <div class="card-body">
            <div class="d-flex align-items-start justify-content-between gap-3">
              <div class="min-w-0">
                <div class="fw-semibold">{{ s.label }}</div>
                <div class="small text-muted">Anchor: {{ s.anchor_type }}</div>
                <div class="small text-muted">
                  Status:
                  <span class="badge {{ s.status_badge_class }}">{{ s.status }}</span>
                </div>
                {% if s.last_edited_at %}
                  <div class="small text-muted">
                    Last saved: {{ s.last_edited_at|date:"Y-m-d H:i:s" }}{% if s.last_edited_by %} by {{ s.last_edited_by }}{% endif %}
                  </div>
                {% endif %}
              </div>
              <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end">
                {% if s.marker == "INTENT" %}
                  <form method="post" action="{% url 'projects:project_review_intent_seed' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="seed_style" value="{{ seed_style }}">
                    <input type="hidden" name="seed_constraints" value="{{ seed_constraints }}">
                    <button class="btn btn-sm btn-outline-primary" type="submit"
                            data-seed-btn="1"
                            {% if s.has_content %}data-seed-confirm="1" data-seed-confirm-msg="This will replace INTENT from accepted CKO using LLM. Continue?"{% endif %}>
                      Seed
                    </button>
                  </form>
                  <button class="btn btn-sm btn-outline-secondary" type="button"
                          onclick="var d=document.getElementById('rw-intent-editor-{{ s.marker }}'); if(d){d.open=true; d.scrollIntoView({behavior:'smooth', block:'start'});}">
                    Edit intent
                  </button>
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'projects:project_review_print_intent' project.id %}?view={{ intent_view_style }}" target="_blank">
                    Print
                  </a>
                {% endif %}
                {% if s.marker == "EXECUTE" %}
                  <button class="btn btn-sm btn-outline-secondary" type="button"
                          onclick="var d=document.getElementById('rw-execute-editor-{{ s.marker }}'); if(d){d.open=true; d.scrollIntoView({behavior:'smooth', block:'start'});}">
                    Edit execute
                  </button>
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'projects:project_review_print_execute' project.id %}?view={{ intent_view_style }}" target="_blank">
                    Print
                  </a>
                {% endif %}
                {% if s.marker == "EXECUTE" and s.can_reseed_execute %}
                  <form method="post" action="{% url 'projects:project_review_execute_reseed' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="seed_style" value="{{ seed_style }}">
                    <input type="hidden" name="seed_constraints" value="{{ seed_constraints }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit"
                            data-seed-btn="1"
                            {% if s.has_content %}data-seed-confirm="1" data-seed-confirm-msg="This will replace EXECUTE from current ROUTE and regenerate stage actions. Continue?"{% endif %}>
                      Seed
                    </button>
                  </form>
                {% endif %}
                {% if s.has_content and s.status == "DRAFT" %}
                  <form method="post" action="{% url 'projects:project_review_anchor_status' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="marker" value="{{ s.marker }}" />
                    <input type="hidden" name="action" value="propose" />
                    <button class="btn btn-sm btn-outline-primary" type="submit">Propose</button>
                  </form>
                {% elif s.status == "PROPOSED" %}
                  <form method="post" action="{% url 'projects:project_review_anchor_status' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="marker" value="{{ s.marker }}" />
                    <input type="hidden" name="action" value="lock" />
                    <button class="btn btn-sm btn-outline-success" type="submit">Lock</button>
                  </form>
                {% elif s.status == "PASS_LOCKED" %}
                  <form method="post" action="{% url 'projects:project_review_anchor_status' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="marker" value="{{ s.marker }}" />
                    <input type="hidden" name="action" value="reopen" />
                    <button class="btn btn-sm btn-outline-secondary" type="submit">Reopen</button>
                  </form>
                {% endif %}
                {% if s.marker == "ROUTE" %}
                  <form method="post" action="{% url 'projects:project_review_route_seed_from_intent' project.id %}" class="m-0" data-route-seed-form="1">
                    {% csrf_token %}
                    <input type="hidden" name="force_llm" value="1" />
                    <input type="hidden" name="seed_style" value="{{ seed_style }}">
                    <input type="hidden" name="seed_constraints" value="{{ seed_constraints }}">
                    <button class="btn btn-sm btn-outline-primary" type="submit"
                            data-seed-btn="1"
                            {% if s.has_content %}data-seed-confirm="1" data-seed-confirm-msg="This will replace ROUTE from INTENT using LLM. Continue?"{% endif %}>
                      Seed
                    </button>
                  </form>
                  {% if s.route_versions %}
                    <form method="post" action="{% url 'projects:project_review_route_restore' project.id %}" class="m-0 d-flex align-items-center gap-1">
                      {% csrf_token %}
                      <input type="hidden" name="snapshot" value="before" />
                      <select class="form-select form-select-sm" name="audit_id" style="min-width: 14rem;">
                        {% for rv in s.route_versions %}
                          <option value="{{ rv.audit_id }}">
                            {{ rv.created_at|date:"Y-m-d H:i" }} {% if rv.changed_by_name %}- {{ rv.changed_by_name }}{% endif %}
                          </option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-sm btn-outline-secondary" type="submit"
                              onclick="return confirm('Restore selected route version? This replaces current route draft.');">
                        Restore
                      </button>
                    </form>
                  {% endif %}
                {% endif %}
                {% if s.chat_id %}
                  <a class="btn btn-sm btn-outline-primary"
                     href="?review_chat_id={{ s.chat_id }}&review_chat_open=1#review-{{ s.marker|lower }}">
                    Open review conference
                  </a>
                {% else %}
                  <form method="post" action="{% url 'projects:project_review_chat_open' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="marker" value="{{ s.marker }}" />
                    <button class="btn btn-sm btn-outline-primary" type="submit">
                      Open review conference
                    </button>
                  </form>
                {% endif %}
                {% if s.marker == "ROUTE" %}
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'projects:project_review_print_route' project.id %}?view={{ intent_view_style }}" target="_blank">
                    Print
                  </a>
                {% endif %}
              </div>
            </div>

          {% if s.marker != "INTENT" and s.marker != "ROUTE" and s.marker != "EXECUTE" %}
            <details class="mt-3" data-review-detail-key="anchor-{{ s.marker|lower }}" open>
              <summary class="fw-semibold">Anchor</summary>
              {% if s.content_html %}
                <div class="border rounded p-2 bg-white rw-artefact-doc">
                  {{ s.content_html|safe }}
                </div>
              {% elif s.content %}
                <div class="border rounded p-2 bg-white" style="white-space:pre-wrap;">{{ s.content }}</div>
              {% else %}
                <div class="text-muted small">No anchor content yet.</div>
              {% endif %}
              {% if s.content_json_text %}
                <details class="mt-2">
                  <summary class="small text-muted">View JSON</summary>
                  <pre class="mt-2 mb-0" style="white-space:pre-wrap;">{{ s.content_json_text }}</pre>
                </details>
              {% endif %}
            </details>
          {% endif %}

          {% if s.marker == "INTENT" and intent_view_style == "default" %}
            <details class="mt-3" id="rw-intent-editor-{{ s.marker }}">
              <summary class="fw-semibold">Edit intent</summary>
              <form method="post" action="{% url 'projects:project_review_anchor_update' project.id %}" class="mt-2" data-ajax-save-form="1">
                {% csrf_token %}
                <input type="hidden" name="marker" value="{{ s.marker }}" />
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-summary-{{ s.marker }}">Canonical summary</label>
                    <textarea class="form-control" id="rw-cko-summary-{{ s.marker }}" name="cko_canonical_summary" rows="2">{{ s.intent_fields.canonical_summary }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-scope-{{ s.marker }}">Scope</label>
                    <textarea class="form-control" id="rw-cko-scope-{{ s.marker }}" name="cko_scope" rows="3">{{ s.intent_fields.scope }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-statement-{{ s.marker }}">Statement</label>
                    <textarea class="form-control" id="rw-cko-statement-{{ s.marker }}" name="cko_statement" rows="3">{{ s.intent_fields.statement }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-basis-{{ s.marker }}">Supporting basis</label>
                    <textarea class="form-control" id="rw-cko-basis-{{ s.marker }}" name="cko_supporting_basis" rows="4">{{ s.intent_fields.supporting_basis }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-assumptions-{{ s.marker }}">Assumptions</label>
                    <textarea class="form-control" id="rw-cko-assumptions-{{ s.marker }}" name="cko_assumptions" rows="3">{{ s.intent_fields.assumptions }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-alts-{{ s.marker }}">Alternatives considered</label>
                    <textarea class="form-control" id="rw-cko-alts-{{ s.marker }}" name="cko_alternatives_considered" rows="4">{{ s.intent_fields.alternatives_considered }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-uncertainties-{{ s.marker }}">Uncertainties / limits</label>
                    <textarea class="form-control" id="rw-cko-uncertainties-{{ s.marker }}" name="cko_uncertainties_limits" rows="3">{{ s.intent_fields.uncertainties_limits }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-cko-provenance-{{ s.marker }}">Provenance</label>
                    <textarea class="form-control" id="rw-cko-provenance-{{ s.marker }}" name="cko_provenance" rows="3">{{ s.intent_fields.provenance }}</textarea>
                  </div>
                </div>
                <div class="mt-2">
                  <button type="submit" class="btn btn-sm btn-outline-secondary" name="action" value="normalise">
                    Normalise spacing
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary"
                          onclick="var d=document.getElementById('rw-intent-editor-{{ s.marker }}'); if(d){d.open=false;}">
                    Exit
                  </button>
                </div>
              </form>
            </details>
          {% endif %}

          {% if s.marker == "ROUTE" %}
            <details class="mt-3" id="rw-route-editor-{{ s.marker }}"
                     data-review-detail-key="route-editor-{{ s.marker|lower }}"
                     {% if s.has_content %}open{% endif %}>
              <summary class="fw-semibold">Edit route</summary>
              <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                {% if s.route_summary_chat_id %}
                  <a class="btn btn-sm btn-outline-primary"
                     href="?review_chat_id={{ s.route_summary_chat_id }}&review_chat_open=1#review-{{ s.marker|lower }}">
                    Open summary review
                  </a>
                {% else %}
                  <form method="post" action="{% url 'projects:project_review_stage_chat_open' project.id %}" class="m-0">
                    {% csrf_token %}
                    <input type="hidden" name="marker" value="ROUTE" />
                    <input type="hidden" name="stage_number" value="0" />
                    <button class="btn btn-sm btn-outline-primary" type="submit">Open summary review</button>
                  </form>
                {% endif %}
              </div>
              {% if intent_view_style == "cockpit" %}
                {% include "projects/_route_cockpit.html" %}
              {% elif intent_view_style == "mission" %}
                {% include "projects/_route_mission.html" %}
              {% else %}
              <form id="rw-route-save-{{ s.marker }}" method="post" action="{% url 'projects:project_review_anchor_update' project.id %}" class="mt-2" data-ajax-save-form="1">
                {% csrf_token %}
                <input type="hidden" name="marker" value="{{ s.marker }}" />
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-route-summary-{{ s.marker }}">PDO summary</label>
                    <textarea class="form-control" id="rw-route-summary-{{ s.marker }}" name="route_pdo_summary" rows="2">{{ s.route_fields.pdo_summary }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-route-cko1-{{ s.marker }}">CKO alignment: stage 1 inputs match</label>
                    <textarea class="form-control" id="rw-route-cko1-{{ s.marker }}" name="route_cko_stage1" rows="2">{{ s.route_fields.cko_alignment_stage1_inputs_match }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-route-ckof-{{ s.marker }}">CKO alignment: final outputs match</label>
                    <textarea class="form-control" id="rw-route-ckof-{{ s.marker }}" name="route_cko_final" rows="2">{{ s.route_fields.cko_alignment_final_outputs_match }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-route-purpose-{{ s.marker }}">Planning purpose</label>
                    <textarea class="form-control" id="rw-route-purpose-{{ s.marker }}" name="route_planning_purpose" rows="3">{{ s.route_fields.planning_purpose }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-route-constraints-{{ s.marker }}">Planning constraints</label>
                    <textarea class="form-control" id="rw-route-constraints-{{ s.marker }}" name="route_planning_constraints" rows="3">{{ s.route_fields.planning_constraints }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted" for="rw-route-assumptions-{{ s.marker }}">Assumptions</label>
                    <textarea class="form-control" id="rw-route-assumptions-{{ s.marker }}" name="route_assumptions" rows="3">{{ s.route_fields.assumptions }}</textarea>
                  </div>
                </div>
                <div class="mt-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary"
                          onclick="var d=document.getElementById('rw-route-editor-{{ s.marker }}'); if(d){d.open=false;}">
                    Exit
                  </button>
                </div>
                {% if s.route_stages %}
                  <div class="mt-3">
                    <div class="fw-semibold">Stages</div>
                    {% for st in s.route_stages %}
                      <div class="border rounded p-2 mt-2 bg-white">
                        <input type="hidden" name="route_stage_number" value="{{ st.stage_number }}">
                        <input type="hidden" name="route_stage_{{ forloop.counter }}_stage_id" value="{{ st.stage_id }}">
                        <div class="row g-2">
                          <div class="col-12 col-md-3">
                            <label class="form-label small text-muted">Stage number</label>
                            <input class="form-control" value="{{ st.stage_number }}" disabled>
                          </div>
                          <div class="col-12 col-md-3">
                            <label class="form-label small text-muted">Stage id</label>
                            <input class="form-control" value="{{ st.stage_id }}" disabled>
                          </div>
                          <div class="col-12 col-md-3">
                            <label class="form-label small text-muted">Status</label>
                            <input class="form-control" name="route_stage_{{ forloop.counter }}_status" value="{{ st.status }}">
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Title</label>
                            <input class="form-control" name="route_stage_{{ forloop.counter }}_title" value="{{ st.title }}">
                          </div>
                          <div class="col-12">
                            <label class="form-label small text-muted">Purpose</label>
                            <textarea class="form-control" name="route_stage_{{ forloop.counter }}_purpose" rows="2">{{ st.purpose }}</textarea>
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Inputs</label>
                            <textarea class="form-control" name="route_stage_{{ forloop.counter }}_inputs" rows="2">{{ st.inputs }}</textarea>
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Stage process</label>
                            <textarea class="form-control" name="route_stage_{{ forloop.counter }}_stage_process" rows="2">{{ st.stage_process }}</textarea>
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Outputs</label>
                            <textarea class="form-control" name="route_stage_{{ forloop.counter }}_outputs" rows="2">{{ st.outputs }}</textarea>
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Assumptions</label>
                            <textarea class="form-control" name="route_stage_{{ forloop.counter }}_assumptions" rows="2">{{ st.assumptions }}</textarea>
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Duration estimate</label>
                            <textarea class="form-control" name="route_stage_{{ forloop.counter }}_duration_estimate" rows="2">{{ st.duration_estimate }}</textarea>
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label small text-muted">Risks / notes</label>
                            <textarea class="form-control" name="route_stage_{{ forloop.counter }}_risks_notes" rows="2">{{ st.risks_notes }}</textarea>
                          </div>
                        </div>
                        <div class="mt-2 d-flex gap-2">
                          {% if st.stage_chat_id %}
                            <a class="btn btn-sm btn-outline-primary"
                               href="?review_chat_id={{ st.stage_chat_id }}&review_chat_open=1#review-{{ s.marker|lower }}">
                              Open stage review
                            </a>
                          {% else %}
                            <button class="btn btn-sm btn-outline-primary"
                                    type="button"
                                    data-open-stage-review="1"
                                    data-action-url="{% url 'projects:project_review_stage_chat_open' project.id %}"
                                    data-marker="ROUTE"
                                    data-stage-number="{{ st.stage_number }}"
                                    data-stage-id="{{ st.stage_id|default:'' }}"
                                    data-chat-container-id="rw-stage-chat-container-ROUTE-{{ st.stage_number }}">
                              Open stage review
                            </button>
                          {% endif %}
                        </div>
                        <div id="rw-stage-chat-container-ROUTE-{{ st.stage_number }}">
                          {% include "projects/review_inline_chat.html" with chat_ctx=st.stage_chat_ctx %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-muted small mt-2">No stages yet.</div>
                {% endif %}
                <div class="mt-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary"
                          onclick="var d=document.getElementById('rw-route-editor-{{ s.marker }}'); if(d){d.open=false;}">
                    Exit
                  </button>
                </div>
              </form>
              {% endif %}
            </details>
          {% endif %}

          {% if s.marker == "INTENT" %}
            {% include "projects/intent_detail.html" %}
          {% endif %}

          {% if s.marker == "EXECUTE" %}
            <details class="mt-3" id="rw-execute-editor-{{ s.marker }}"
                     data-review-detail-key="execute-editor-{{ s.marker|lower }}"
                     {% if s.has_content %}open{% endif %}>
              <summary class="fw-semibold">Execute</summary>
              <form id="rw-execute-save-{{ s.marker }}" method="post" action="{% url 'projects:project_review_anchor_update' project.id %}" class="m-0" data-ajax-save-form="1">
                {% csrf_token %}
                <input type="hidden" name="marker" value="{{ s.marker }}" />
              </form>
              <div class="d-flex gap-2 mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        onclick="var d=document.getElementById('rw-execute-editor-{{ s.marker }}'); if(d){d.open=false;}">
                  Exit
                </button>
              </div>
              <details class="mt-3" data-review-detail-key="execute-outputs-{{ s.marker|lower }}">
                <summary class="fw-semibold">Outputs</summary>
                <div class="mt-2">
                  {% if s.execute_outputs %}
                    {% for out in s.execute_outputs %}
                      <div class="border rounded p-2 mt-2 bg-white">
                        <div class="d-flex flex-wrap gap-2 small text-muted">
                          <div>Id: {{ out.output_id }}</div>
                          <div>Status: {{ out.status }}</div>
                          <div>Stage: {{ out.stage_id }}</div>
                        </div>
                        <div class="mt-1">{{ out.title }}</div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="text-muted small">No outputs yet.</div>
                  {% endif %}
                </div>
              </details>
              <div class="mt-3">
                <div class="fw-semibold">Stages</div>
                <div class="d-flex gap-2 mt-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary"
                          onclick="var d=document.getElementById('rw-execute-editor-{{ s.marker }}'); if(d){d.open=false;}">
                    Exit
                  </button>
                </div>
                {% if s.execute_stages %}
                  {% for st in s.execute_stages %}
                    <div class="border rounded p-2 mt-2 bg-white">
                      <div class="small fw-semibold mb-2">Stage {{ st.stage_number }}{% if st.stage_id %} ({{ st.stage_id }}){% endif %}: {{ st.title }}</div>
                      <div class="row g-2">
                        <input type="hidden" name="execute_stage_number" value="{{ st.stage_number }}" form="rw-execute-save-{{ s.marker }}">
                        <input type="hidden" name="execute_stage_{{ forloop.counter }}_stage_id" value="{{ st.stage_id }}" form="rw-execute-save-{{ s.marker }}">
                        <div class="col-12 col-md-3">
                          <label class="form-label small text-muted">Status</label>
                          <select class="form-select" name="execute_stage_{{ forloop.counter }}_status" form="rw-execute-save-{{ s.marker }}">
                            {% for choice in s.execute_stage_status_choices %}
                              <option value="{{ choice }}" {% if st.status == choice %}selected{% endif %}>{{ choice }}</option>
                            {% endfor %}
                            {% if st.status and st.status not in s.execute_stage_status_choices %}
                              <option value="{{ st.status }}" selected>{{ st.status }}</option>
                            {% endif %}
                          </select>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Next actions</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_next_actions" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.next_actions }}</textarea>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Notes</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_notes" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.notes }}</textarea>
                        </div>
                        <div class="col-12">
                          <label class="form-label small text-muted">Purpose</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_purpose" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.purpose }}</textarea>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Inputs</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_inputs" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.inputs }}</textarea>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Stage process</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_stage_process" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.stage_process }}</textarea>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Outputs</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_outputs" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.outputs }}</textarea>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Assumptions</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_assumptions" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.assumptions }}</textarea>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Duration estimate</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_duration_estimate" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.duration_estimate }}</textarea>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label small text-muted">Risks / notes</label>
                          <textarea class="form-control" name="execute_stage_{{ forloop.counter }}_risks_notes" rows="2" form="rw-execute-save-{{ s.marker }}">{{ st.risks_notes }}</textarea>
                        </div>
                      </div>
                      <div class="mt-2 d-flex gap-2">
                        {% if st.stage_chat_id %}
                          <a class="btn btn-sm btn-outline-primary"
                             href="?review_chat_id={{ st.stage_chat_id }}&review_chat_open=1#review-{{ s.marker|lower }}">
                            Open stage review
                          </a>
                        {% else %}
                          <button class="btn btn-sm btn-outline-primary"
                                  type="button"
                                  data-open-stage-review="1"
                                  data-action-url="{% url 'projects:project_review_stage_chat_open' project.id %}"
                                  data-marker="EXECUTE"
                                  data-stage-number="{{ st.stage_number }}"
                                  data-stage-id="{{ st.stage_id|default:'' }}"
                                  data-chat-container-id="rw-stage-chat-container-EXECUTE-{{ st.stage_number }}">
                            Open stage review
                          </button>
                        {% endif %}
                      </div>
                      <div id="rw-stage-chat-container-EXECUTE-{{ st.stage_number }}">
                        {% include "projects/review_inline_chat.html" with chat_ctx=st.stage_chat_ctx %}
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted small mt-2">No stages yet.</div>
                {% endif %}
              </div>
              <div class="mt-3">
                <div class="fw-semibold">Project summary</div>
                <div class="row g-2 mt-1">
                  <div class="col-12">
                    <label class="form-label small text-muted">Next actions</label>
                    <textarea class="form-control" rows="3" readonly>{{ s.execute_fields.next_actions_summary }}</textarea>
                  </div>
                  <div class="col-12">
                    <label class="form-label small text-muted">Notes</label>
                    <textarea class="form-control" rows="3" readonly>{{ s.execute_fields.notes_summary }}</textarea>
                  </div>
                </div>
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        onclick="var d=document.getElementById('rw-execute-editor-{{ s.marker }}'); if(d){d.open=false;}">
                  Exit
                </button>
              </div>
            </details>
          {% endif %}

          <details class="mt-3" data-review-detail-key="audit-{{ s.marker|lower }}">
            <summary class="fw-semibold">Audit trail</summary>
            {% if s.audit_entries %}
              <div class="mt-2 small">
                {% for ev in s.audit_entries %}
                  <div class="border rounded p-2 mb-2 bg-white">
                    <div class="text-muted">
                      {{ ev.created_at|date:"Y-m-d H:i:s" }} |
                      {{ ev.changed_by.username|default:"(unknown)" }} |
                      {{ ev.change_type }}
                    </div>
                    <div>{{ ev.summary }}</div>
                    {% if ev.status_before or ev.status_after %}
                      <div class="text-muted">Status: {{ ev.status_before|default:"-" }} -> {{ ev.status_after|default:"-" }}</div>
                    {% endif %}
                    {% if ev.overall_status_after %}
                      <div class="text-muted">
                        Overall status "{{ ev.overall_status_after }}" lasted {{ ev.overall_status_duration_text }}.
                      </div>
                    {% endif %}
                    {% if ev.diff_rows %}
                      <details class="mt-1">
                        <summary class="small text-muted">Changed fields</summary>
                        <div class="mt-1">
                          {% for d in ev.diff_rows %}
                            <div class="small mb-1">
                              <span class="fw-semibold">{{ d.key }}</span>:
                              <span class="text-muted">"{{ d.before|default:"" }}"</span>
                              -> "{{ d.after|default:"" }}"
                            </div>
                          {% endfor %}
                        </div>
                      </details>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-muted small mt-2">No audit entries yet.</div>
            {% endif %}
          </details>

          {% include "projects/review_inline_chat.html" with chat_ctx=s.chat_ctx %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
<script>
(function () {
  var storageKey = "review_details_" + "{{ project.id }}";
  var details = document.querySelectorAll("details[data-review-detail-key]");

  var saved = {};
  try {
    saved = JSON.parse(localStorage.getItem(storageKey) || "{}");
  } catch (e) {
    saved = {};
  }

  details.forEach(function (el) {
    var k = el.getAttribute("data-review-detail-key");
    if (!k) return;
    if (Object.prototype.hasOwnProperty.call(saved, k)) {
      el.open = !!saved[k];
    }
    el.addEventListener("toggle", function () {
      saved[k] = !!el.open;
      try {
        localStorage.setItem(storageKey, JSON.stringify(saved));
      } catch (e) {}
    });
  });

  var params = new URLSearchParams(window.location.search || "");
  var forceEdit = (params.get("review_edit") || "").toLowerCase();
  var forceAnchor = (params.get("review_anchor_open") || "").toLowerCase();
  if (forceEdit && (forceAnchor === "1" || forceAnchor === "true" || forceAnchor === "yes")) {
    var anchorKey = "anchor-" + forceEdit;
    var editorKey = forceEdit + "-editor-" + forceEdit;
    var anchorEl = document.querySelector("details[data-review-detail-key='" + anchorKey + "']");
    var editorEl = document.querySelector("details[data-review-detail-key='" + editorKey + "']");
    if (anchorEl) {
      anchorEl.open = true;
      saved[anchorKey] = true;
    }
    if (editorEl) {
      editorEl.open = true;
      saved[editorKey] = true;
    }
    try {
      localStorage.setItem(storageKey, JSON.stringify(saved));
    } catch (e) {}
  }

  function showSaveStatus(target, msg, ok) {
    if (!target) return;
    var prior = target.querySelector(".rw-route-stage-save-status");
    if (prior && prior.parentNode) {
      prior.parentNode.removeChild(prior);
    }
    var note = document.createElement("div");
    note.className = "rw-route-stage-save-status small mt-2 " + (ok ? "text-success" : "text-danger");
    note.textContent = msg || (ok ? "Stage saved." : "Save failed.");
    target.appendChild(note);
  }

  function buildUrlEncodedBody(form, submitter) {
    var fd = new FormData(form);
    if (submitter && submitter.name) {
      fd.set(submitter.name, submitter.value || "");
    }
    fd.set("ajax", "1");
    var body = new URLSearchParams();
    fd.forEach(function (v, k) { body.append(k, String(v || "")); });
    return body.toString();
  }

  function getCsrfToken() {
    var m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  }

  function sendAjaxSave(form, submitter, statusTarget, successMsg) {
    if (!form) return;
    var postUrl = form.getAttribute("action") || window.location.pathname;
    var btn = submitter || null;
    var oldText = btn ? btn.textContent : "";
    if (btn) {
      btn.disabled = true;
      btn.textContent = "Saving...";
    }
    fetch(postUrl, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCsrfToken()
      },
      body: buildUrlEncodedBody(form, submitter)
    })
    .then(function (r) {
      var ct = (r.headers.get("content-type") || "").toLowerCase();
      if (ct.indexOf("application/json") !== -1) {
        return r.json();
      }
      return r.text().then(function (t) {
        return { ok: false, message: "Save failed (" + r.status + ").", detail: (t || "").slice(0, 220) };
      });
    })
    .then(function (data) {
      if (!data || !data.ok) {
        var msg = (data && data.message) || "Save failed.";
        if (data && data.detail) {
          msg += " " + data.detail;
        }
        showSaveStatus(statusTarget || form, msg, false);
        return;
      }
      showSaveStatus(statusTarget || form, (data && data.message) || successMsg || "Saved.", true);
      if (submitter && submitter.hasAttribute("data-close-on-success")) {
        var details = submitter.closest("details") || form.closest("details");
        if (details) {
          details.open = false;
        }
      }
    })
    .catch(function () {
      showSaveStatus(statusTarget || form, "Save failed.", false);
    })
    .finally(function () {
      if (btn) {
        btn.disabled = false;
        btn.textContent = oldText;
      }
    });
  }

  var autosaveTimers = new WeakMap();

  document.addEventListener("change", function (ev) {
    var target = ev.target;
    if (!target || !target.matches("textarea, input, select")) return;
    if (target.disabled || target.readOnly) return;
    var form = target.form || target.closest("form");
    if (!form || !form.matches("form[data-ajax-save-form='1']")) return;
    if (autosaveTimers.has(form)) {
      clearTimeout(autosaveTimers.get(form));
    }
    var statusTarget = target.closest(".border") || form;
    var timer = setTimeout(function () {
      sendAjaxSave(form, null, statusTarget, "Saved.");
      autosaveTimers.delete(form);
    }, 220);
    autosaveTimers.set(form, timer);
  });

  document.addEventListener("click", function (ev) {
    var seedBtn = ev.target.closest("button[data-seed-btn='1']");
    if (seedBtn && seedBtn.hasAttribute("data-seed-confirm")) {
      var msg = seedBtn.getAttribute("data-seed-confirm-msg") || "This will replace the current content. Reseed now?";
      var ok = window.confirm(msg);
      if (!ok) {
        ev.preventDefault();
        return;
      }
    }

    var saveExitBtn = ev.target.closest("button[data-close-on-success]");
    if (saveExitBtn) {
      var saveExitForm = saveExitBtn.form || saveExitBtn.closest("form[data-ajax-save-form='1']");
      if (saveExitForm && saveExitForm.matches("form[data-ajax-save-form='1']")) {
        ev.preventDefault();
        var saveExitTarget = saveExitBtn.parentElement || saveExitForm;
        sendAjaxSave(saveExitForm, saveExitBtn, saveExitTarget, "Saved.");
        return;
      }
    }

    var openStageBtn = ev.target.closest("button[data-open-stage-review='1']");
    if (openStageBtn) {
      ev.preventDefault();
      var actionUrl = openStageBtn.getAttribute("data-action-url") || "";
      if (!actionUrl) return;
      var marker = openStageBtn.getAttribute("data-marker") || "";
      var stageNumber = openStageBtn.getAttribute("data-stage-number") || "";
      var stageId = openStageBtn.getAttribute("data-stage-id") || "";
      var containerId = openStageBtn.getAttribute("data-chat-container-id") || "";
      var body = new URLSearchParams();
      body.set("marker", marker);
      body.set("stage_number", stageNumber);
      if (stageId) body.set("stage_id", stageId);
      body.set("ajax", "1");
      var oldText = openStageBtn.textContent || "";
      openStageBtn.disabled = true;
      openStageBtn.textContent = "Opening...";
      fetch(actionUrl, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrfToken()
        },
        body: body.toString()
      })
      .then(function (r) {
        var ct = (r.headers.get("content-type") || "").toLowerCase();
        if (ct.indexOf("application/json") !== -1) {
          return r.json().then(function (d) { return { ok: r.ok, data: d }; });
        }
        return { ok: false, data: null };
      })
      .then(function (resp) {
        var data = (resp && resp.data) || {};
        if (!resp || !resp.ok || !data || !data.ok) {
          window.location.reload();
          return;
        }
        var host = containerId ? document.getElementById(containerId) : null;
        if (host && data.drawer_html) {
          host.innerHTML = data.drawer_html;
          var details = host.querySelector("details.rw-drawer");
          if (details) details.open = true;
        }
        var nextUrl = String(data.redirect_url || "");
        if (nextUrl && window.history && window.history.replaceState) {
          window.history.replaceState({}, "", nextUrl);
        }
      })
      .catch(function () {
        window.location.reload();
      })
      .finally(function () {
        openStageBtn.disabled = false;
        openStageBtn.textContent = oldText;
      });
      return;
    }

    var btn = ev.target.closest("button[data-save-route-stage]");
    if (!btn) return;
    ev.preventDefault();
    var form = btn.closest("form[data-ajax-save-form='1']");
    if (!form) {
      var details = btn.closest("details");
      if (details) {
        form = details.querySelector("form[data-ajax-save-form='1']");
      }
    }
    if (!form) return;
    var actionVal = btn.getAttribute("value") || "";
    if (!actionVal) return;

    sendAjaxSave(form, btn, form, "Stage saved.");
  });

  document.addEventListener("submit", function (ev) {
    var form = ev.target;
    if (form && form.matches("form[data-route-seed-form='1']")) {
      ev.preventDefault();
      var submitter = ev.submitter || form.querySelector("button[type='submit']");
      var btn = submitter || null;
      var oldText = btn ? btn.textContent : "";
      if (btn) {
        btn.disabled = true;
        btn.textContent = "Seeding...";
      }
      var body = new URLSearchParams();
      var fd = new FormData(form);
      fd.forEach(function (v, k) { body.append(k, String(v || "")); });
      body.set("ajax", "1");
      fetch(form.getAttribute("action") || window.location.pathname, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrfToken()
        },
        body: body.toString()
      })
      .then(function (r) {
        var ct = (r.headers.get("content-type") || "").toLowerCase();
        if (ct.indexOf("application/json") !== -1) {
          return r.json().then(function (d) { return { ok: r.ok, data: d }; });
        }
        return { ok: false, data: { ok: false, message: "Seed failed (" + r.status + ")." } };
      })
      .then(function (resp) {
        var data = (resp && resp.data) || {};
        if (!resp.ok || !data.ok) {
          showSaveStatus(form, (data && data.message) || "Seed failed.", false);
          return;
        }
        showSaveStatus(form, data.message || "Seeded.", true);
        var url = String(data.redirect_url || "");
        if (url) {
          window.location.assign(url);
          return;
        }
        window.location.reload();
      })
      .catch(function () {
        showSaveStatus(form, "Seed failed.", false);
      })
      .finally(function () {
        if (btn) {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });
      return;
    }
    if (!form || !form.matches("form[data-ajax-save-form='1']")) return;
    var submitter = ev.submitter || null;
    if (submitter && submitter.hasAttribute("data-save-route-stage")) return;
    ev.preventDefault();
    var statusTarget = form;
    if (submitter && submitter.parentElement) {
      statusTarget = submitter.parentElement;
    } else if (submitter && submitter.form !== form && submitter.closest("details")) {
      statusTarget = submitter.closest("details");
    }
    sendAjaxSave(form, submitter, statusTarget, "Saved.");
  });
})();
</script>
{% endblock %}
