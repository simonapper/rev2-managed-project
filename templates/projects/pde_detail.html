{# -*- coding: utf-8 -*- #}
{# templates/projects/pde_detail.html #}
{% extends "base.html" %}

{% block title %}PDE — {{ project.name }}{% endblock %}

{% block content %}
<div class="rw-main-inner">
  <div class="rw-workarea">
    <div class="row g-3">

      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">

            <div class="d-flex align-items-start justify-content-between gap-3">
              <div>
                <div class="fw-semibold">Project Definition Environment</div>
                <div class="small text-secondary">Draft -> validate -> lock -> commit (DEFINED).</div>
              </div>
            </div>

            <hr class="my-3" />

            <!-- 1) Seed panel (exploratory / destructive) -->
            <div class="mb-3">
              <div class="fw-semibold">Seed (epistemic input)</div>
              <div class="small text-secondary mb-2">
                Drafting overwrites current draft field values (not locked ones).
              </div>

              <form method="post" class="m-0">
                {% csrf_token %}
                <input type="hidden" name="action" value="draft" />

                <textarea class="form-control"
                          name="seed_text"
                          rows="4"
                          style="font-size:0.9rem;"
                          placeholder="Describe what this project is and why it exists...">{{ seed_text }}</textarea>

                <div class="d-flex align-items-center justify-content-between mt-2">
                  <div class="small text-secondary">Tip: keep it concrete. One or two paragraphs is enough.</div>
                  {% if pde_can_commit %}
                    <button class="btn btn-sm btn-outline-primary" type="submit">Draft PDE from Seed</button>
                  {% endif %}
                </div>
              </form>
            </div>

            <hr class="my-3" />

            <!-- 2) Field blocks (draft + refinement) -->
            <form method="post" class="m-0" id="pdeFieldsForm">
              {% csrf_token %}
              <input type="hidden" name="action" id="pdeAction" value="" />
              <input type="hidden" name="field_key" id="pdeFieldKey" value="" />
              <input type="hidden" name="value_text" id="pdeValueText" value="" />

              {% for spec in specs %}
                {# Use 1-based index and force it to a string for safe concatenation #}
                {% with idx=forloop.counter|stringformat:"s" %}
                {% with ta_id="pde-field-"|add:idx %}
                <div id="pde-field-{{ spec.key }}" class="mb-4">

                  <div class="d-flex align-items-start justify-content-between gap-3">
                    <div class="min-w-0">
                      <div class="fw-semibold">{{ spec.label }}</div>

                      {% if spec.summary %}
                        <div class="small text-secondary">{{ spec.summary }}</div>
                      {% endif %}

                      <div class="small text-muted mt-1">
                        {{ spec.tier }}{% if spec.required %} — required{% endif %}
                        {% if spec.status %}
                          — <span class="fw-semibold">
                            {% if spec.status == "PROPOSED" %}
                              PROPOSED{% if spec.proposed_by %} ({{ spec.proposed_by }}){% endif %}
                            {% elif spec.status == "PASS_LOCKED" %}
                              LOCKED{% if spec.locked_by %} ({{ spec.locked_by }}){% endif %}
                            {% else %}
                              {{ spec.status }}
                            {% endif %}
                          </span>
                        {% endif %}
                      </div>
                    </div>

                    <div class="text-end">
                      {% if spec.status == "PASS_LOCKED" %}
                        <span class="badge bg-success">Locked</span>
                      {% elif spec.status == "PROPOSED" %}
                        <span class="badge bg-warning text-dark">Proposed</span>
                      {% else %}
                        <span class="badge bg-secondary">Draft</span>
                      {% endif %}
                    </div>
                  </div>

                  {% if spec.help_text %}
                    <details class="mt-2">
                      <summary class="small text-primary" style="cursor:pointer;">What to write here</summary>
                      <div class="small text-muted mt-2" style="white-space:pre-wrap;">{{ spec.help_text }}</div>
                    </details>
                  {% endif %}

                  <div class="mt-2">
                    <textarea class="form-control"
                              id="{{ ta_id }}"
                              name="{{ spec.key }}"
                              rows="4"
                              style="font-size:0.9rem;"
                              {% if spec.status == "PASS_LOCKED" or spec.status == "PROPOSED" and not pde_can_commit %}readonly{% endif %}>{{ spec.value_text }}</textarea>
                  </div>

                  <div class="d-flex gap-2 mt-2">
                    {% if spec.status == "DRAFT" %}
                      <button class="btn btn-sm btn-outline-primary rw-field-action"
                              type="button"
                              data-action="propose_lock"
                              data-field-key="{{ spec.key }}">
                        {% if pde_can_commit %}Validate &amp; Lock{% else %}Propose Lock{% endif %}
                      </button>
                    {% endif %}

                    {% if spec.status == "PROPOSED" and pde_can_commit %}
                      <button class="btn btn-sm btn-success rw-field-action"
                              type="button"
                              data-action="approve_lock"
                              data-field-key="{{ spec.key }}">
                        Approve Lock
                      </button>
                    {% endif %}

                    {% if spec.status == "PROPOSED" and pde_can_commit %}
                      <button class="btn btn-sm btn-outline-secondary rw-field-action"
                              type="button"
                              data-action="reopen_field"
                              data-field-key="{{ spec.key }}">
                        Reopen
                      </button>
                    {% endif %}

                    {% if spec.status == "PASS_LOCKED" and pde_can_commit %}
                      <button class="btn btn-sm btn-outline-secondary rw-field-action"
                              type="button"
                              data-action="reopen_field"
                              data-field-key="{{ spec.key }}">
                        Reopen
                      </button>
                    {% endif %}

                    {% if spec.status != "PASS_LOCKED" %}
                      {% if spec.status != "PROPOSED" or pde_can_commit %}
                        {% if spec.topic_chat_id %}
                          <a class="btn btn-sm btn-outline-primary"
                             href="?pde_chat_id={{ spec.topic_chat_id }}&pde_chat_open=1#pde-field-{{ spec.key }}">Open topic chat</a>
                        {% else %}
                          <button class="btn btn-sm btn-outline-primary rw-topic-chat-btn"
                                  type="button"
                                  data-spec-key="{{ spec.key }}">
                            Topic chat
                          </button>
                        {% endif %}
                      {% endif %}
                    {% endif %}
                  </div>

                  <!-- Validation output -->
                  {% if spec.last_validation and show_validation_key and show_validation_key == spec.key %}
                    {% if spec.last_validation.issues %}
                      <div class="mt-2 text-danger small">
                        <div class="fw-semibold">Issues</div>
                        <ul class="mb-0">
                          {% for it in spec.last_validation.issues %}
                            <li>{{ it }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}

                    {% if spec.last_validation.questions %}
                      <div class="mt-2 small">
                        <div class="fw-semibold">Questions</div>
                        <ul class="mb-0">
                          {% for q in spec.last_validation.questions %}
                            <li>{{ q }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}

                    {% if spec.last_validation.suggested_revision %}
                      <div class="rw-cde-suggestion mt-2">
                        <div class="fw-semibold mb-1">Suggested revision</div>

                        <div class="rw-cde-suggest-text" style="white-space:pre-wrap;">{{ spec.last_validation.suggested_revision|default:"" }}</div>

                        {% if spec.status != "PASS_LOCKED" %}
                          {% with suggest_id="pde-suggest-"|add:idx %}
                            <textarea id="{{ suggest_id }}" class="d-none" aria-hidden="true">{{ spec.last_validation.suggested_revision|default:"" }}</textarea>

                            <div class="rw-suggest-actions mt-2">
                              <button type="button"
                                      class="btn btn-sm btn-outline-primary rw-suggest-btn"
                                      data-target="{{ ta_id }}"
                                      data-suggest-id="{{ suggest_id }}">
                                <div class="rw-suggest-title">Use suggested text</div>
                                <div class="rw-suggest-sub">(fills box only)</div>
                              </button>
                            </div>
                          {% endwith %}
                        {% endif %}
                      </div>
                    {% endif %}
                  {% endif %}

                  {% include "projects/ppde_inline_chat.html" with chat_ctx=spec.topic_chat_ctx %}

                  <hr class="mt-3" />
                </div>
                {% endwith %}
                {% endwith %}
              {% endfor %}
            </form>

            <form method="post" action="{% url 'projects:pde_topic_chat_open' project.id %}" id="pdeTopicChatForm" class="d-none">
              {% csrf_token %}
              <input type="hidden" name="spec_key" id="pdeTopicChatSpecKey" value="" />
              <input type="hidden" name="open_in" value="drawer" />
            </form>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  document.addEventListener('click', function (ev) {
    var topicBtn = ev.target && ev.target.closest ? ev.target.closest(".rw-topic-chat-btn") : null;
    if (topicBtn) {
      var specKey = topicBtn.getAttribute("data-spec-key") || "";
      var form = document.getElementById("pdeTopicChatForm");
      var input = document.getElementById("pdeTopicChatSpecKey");
      if (form && input && specKey) {
        input.value = specKey;
        form.submit();
      }
      return;
    }
    var btn = ev.target.closest('.rw-suggest-btn');
    if (!btn) return;

    var targetId = btn.getAttribute('data-target') || '';
    var suggestId = btn.getAttribute('data-suggest-id') || '';

    if (!targetId || !suggestId) return;

    var ta = document.getElementById(targetId);
    var suggestEl = document.getElementById(suggestId);

    if (!ta || !suggestEl) return;
    if (ta.hasAttribute('readonly')) return;

    ta.value = (suggestEl.value || suggestEl.textContent || '');
    ta.focus();
  });

  function submitFieldAction(action, fieldKey) {
    var form = document.getElementById('pdeFieldsForm');
    if (!form) return;
    var actionEl = document.getElementById('pdeAction');
    var keyEl = document.getElementById('pdeFieldKey');
    var valEl = document.getElementById('pdeValueText');
    if (actionEl) actionEl.value = action || '';
    if (keyEl) keyEl.value = fieldKey || '';
    if (valEl) valEl.value = '';

    if ((action === 'propose_lock' || action === 'approve_lock') && fieldKey) {
      var ta = null;
      try {
        var list = document.getElementsByName(fieldKey);
        if (list && list.length) ta = list[0];
      } catch (e) {}
      if (ta && valEl) valEl.value = ta.value || '';
    }
    form.submit();
  }

  document.addEventListener('click', function (ev) {
    var btn = ev.target.closest('.rw-field-action');
    if (!btn) return;
    var action = btn.getAttribute('data-action') || '';
    var fieldKey = btn.getAttribute('data-field-key') || '';
    if (!action || !fieldKey) return;
    submitFieldAction(action, fieldKey);
  });

  document.addEventListener('click', function (ev) {
    var btn = ev.target.closest('.rw-pde-validate-btn');
    if (!btn) return;
    var form = document.getElementById('pdeFieldsForm');
    if (!form) return;
    var actionEl = document.getElementById('pdeAction');
    if (actionEl) actionEl.value = 'validate_lock';
    form.submit();
  });
})();
</script>

<script>
(function () {
  var key = "pde_scroll_" + "{{ project.id }}";
  if (window.location.hash) {
    return;
  }
  var saved = sessionStorage.getItem(key);
  if (saved !== null) {
    var y = parseInt(saved, 10);
    if (!isNaN(y)) {
      window.scrollTo(0, y);
    }
  }

  var forms = document.querySelectorAll("form");
  forms.forEach(function (f) {
    f.addEventListener("submit", function () {
      sessionStorage.setItem(key, String(window.scrollY || 0));
    });
  });
})();
</script>
{% endblock %}
