{# -*- coding: utf-8 -*- #}
{# templates/accounts/chat_detail.html #}
{% extends "base.html" %}
{% block title %}{{ chat.title }} — Reasoning Workbench{% endblock %}

{% block content %}
<style>
  .msg-rolled-up { opacity: 0.65; }
  .msg-pinned {
    background-color: #fff3cd !important;
    border: 1px solid #f0c36d !important;
    border-radius: 6px;
  }
  tr.msg-pinned {
    background-color: #fff3cd !important;
  }
  tr.msg-pinned .rw-turn-rowlink {
    background-color: #fff3cd !important;
  }
  tr.msg-pinned > td,
  tr.msg-pinned > th {
    background-color: #fff3cd !important;
  }
  tr.msg-pinned.rw-turn-row-active > td,
  tr.msg-pinned.rw-turn-row-active > th {
    background-color: #fff3cd !important;
  }
  tr.msg-pinned.rw-turn-row-active {
    background-color: #fff3cd !important;
  }
  tr[data-pinned="1"],
  tr[data-pinned="1"] > td,
  tr[data-pinned="1"] > th,
  tr[data-pinned="1"] .rw-turn-rowlink,
  tr[data-pinned="1"].rw-turn-row-active,
  tr[data-pinned="1"].rw-turn-row-active > td,
  tr[data-pinned="1"].rw-turn-row-active > th {
    background-color: #fff3cd !important;
  }
  .msg-ignored { opacity: 0.45; filter: grayscale(0.25); }
</style>
<div class="rw-main-inner">
  <div class="rw-workarea">
    <div class="rw-pane">
      <div class="rw-pane-body pt-0 px-3 pb-3">

        <!--<hr class="my-3">-->

        <!-- Top row: controls + input -->
<div class="d-flex align-items-start justify-content-end mb-2">
  <div class="d-flex flex-column align-items-end gap-1">
    {% if ppde_return_url %}
      <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="{{ ppde_return_url }}">Return to PPDE</a>
    {% endif %}
    {% if topic_chat_return_url %}
      <form method="post" action="{% url 'accounts:chat_topic_delete' chat.id %}" class="m-0">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger rw-topbar-btn rw-btn-xs py-1 px-2" onclick="return confirm('Delete this topic chat?');">Delete topic chat</button>
      </form>
    {% endif %}
    {% if fullscreen %}
      <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_normal }}">Exit full screen</a>
    {% else %}
      <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_fullscreen }}">Full screen</a>
    {% endif %}
    {% if show_system %}
      <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_no_system }}">Hide system</a>
    {% else %}
      <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_with_system }}">Show system</a>
    {% endif %}
    <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="{% url 'accounts:chat_detail_print' chat.id %}?{{ request.GET.urlencode }}" target="_blank" rel="noopener">Print</a>
  </div>
</div>

<form method="post" action="{% url 'accounts:chat_message_create' %}" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="chat_id" value="{{ chat.id }}">
  <input type="hidden" name="next" value="{{ request.get_full_path }}">
  <input type="hidden" name="answer_mode" id="rw-answer-mode" value="{{ answer_mode_default|default:'quick' }}">

  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group btn-group-sm" role="group" aria-label="Answer mode">
        <button type="button" class="btn btn-outline-secondary active" data-answer-mode="quick">Quick</button>
        <button type="button" class="btn btn-outline-secondary" data-answer-mode="full">Full</button>
      </div>
      {% if can_undo_rollup %}
        <button type="submit" form="rw-undo-rollup-form" class="btn btn-sm btn-outline-warning">Undo roll-up</button>
      {% endif %}
    </div>
  </div>
  <div class="small text-secondary mb-2">
    Summary state: cursor {{ pinned_cursor_message_id|default:"none" }},
    updated {% if pinned_updated_at %}{{ pinned_updated_at|date:"Y-m-d H:i" }}{% else %}never{% endif %},
    pending {{ active_window_messages|default:0 }} messages ({{ active_window_turns|default:0 }} turns).
  </div>

  <div class="d-flex align-items-start gap-2 mb-2">
    <div class="flex-grow-1">
      <textarea id="rw-chat-input" name="content" class="form-control" rows="2" placeholder="Type message..."></textarea>
    </div>
    <div class="d-flex flex-column align-items-end gap-1" style="min-width: 160px;">
      <button type="button" class="btn btn-sm btn-outline-secondary rw-btn-same rw-btn-file" id="rw-file-btn">Select file</button>
    </div>
  </div>

  <div id="rw-paste-status" class="small text-secondary mt-2"></div>

  <!-- Select-a-file upload -->
  <div class="mt-2 d-flex align-items-center gap-2">
    <input id="rw-file-input" type="file" style="display:none">
    <span id="rw-file-name" class="small text-secondary"></span>
    <button type="submit" class="btn btn-sm btn-success rw-btn-same">Send</button>
    <div class="ms-auto"></div>
  </div>

  {% if has_last_image %}
    <div class="form-check mt-2">
      <input class="form-check-input"
             type="checkbox"
             id="rw-include-last-image"
             name="include_last_image"
             value="1">
      <label class="form-check-label" for="rw-include-last-image">
        Include last image
      </label>
    </div>
  {% endif %}

  {% if has_last_file %}
    <div class="form-check mt-2">
      <input class="form-check-input"
             type="checkbox"
             id="rw-include-last-file"
             name="include_last_file"
             value="1">
      <label class="form-check-label" for="rw-include-last-file">
        Include last file
      </label>
    </div>
  {% endif %}

</form>
{% if can_undo_rollup %}
  <form id="rw-undo-rollup-form" method="post" action="{% url 'accounts:chat_rollup_undo' chat.id %}" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ request.get_full_path }}">
  </form>
{% endif %}

        <div class="d-flex align-items-center gap-2 mb-2">
          <form method="post" action="{% url 'accounts:chat_use_selected' %}" id="rw-use-selected-form" class="d-flex gap-2 m-0">
            {% csrf_token %}
            <input type="hidden" name="chat_id" value="{{ chat.id }}">
            <input type="hidden" name="selected_text" id="rw-selected-text" value="">
            <input type="hidden" name="apply_mode" id="rw-selected-mode" value="replace">
            <button type="button" class="btn btn-sm btn-outline-primary" data-apply-mode="replace">Use selected (replace)</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-apply-mode="append">Use selected (append)</button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-apply-mode="replace" data-source="input">Use input (replace)</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-apply-mode="append" data-source="input">Use input (append)</button>
          </form>
        </div>

        {# Attachments list #}
        {% if attachments %}
          <div class="mb-3">
            <div class="text-secondary small mb-1">Attachments in this chat</div>
            <div class="list-group" id="rw-attachment-list">
              {% for a in attachments %}
                <div class="list-group-item d-flex justify-content-between align-items-center"
                     data-attachment-id="{{ a.id }}">
                  <div class="d-flex align-items-center gap-2">
                    <a href="{{ a.file.url }}">{{ a.original_name }}</a>
                    <span class="text-secondary small">{{ a.size_bytes }} bytes</span>
                  </div>

                  <button type="button" class="btn btn-sm btn-outline-danger rw-attachment-delete">
                    Delete
                  </button>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if not turn_items %}
          <div class="alert alert-secondary mb-3">No messages yet.</div>
        {% else %}
          <div class="rw-turn-split">

            <div class="rw-turn-list">
              <table class="rw-turn-table">
                <thead>
                  <tr>
                    <th style="width:70px;">
                      <a href="?{% if fullscreen %}fullscreen=1&{% endif %}turn_sort=number&turn_dir={% if turn_sort == 'number' and turn_dir == 'asc' %}desc{% else %}asc{% endif %}{% if active_turn %}&turn={{ active_turn.turn_id }}{% endif %}{% if show_system %}&system=1{% endif %}">
                        Turn
                      </a>
                    </th>
                    <th>
                      <a href="?{% if fullscreen %}fullscreen=1&{% endif %}turn_sort=title&turn_dir={% if turn_sort == 'title' and turn_dir == 'asc' %}desc{% else %}asc{% endif %}{% if active_turn %}&turn={{ active_turn.turn_id }}{% endif %}{% if show_system %}&system=1{% endif %}">
                        Title
                      </a>
                    </th>
                    <th style="width:140px;">
                      <a href="?{% if fullscreen %}fullscreen=1&{% endif %}turn_sort=updated&turn_dir={% if turn_sort == 'updated' and turn_dir == 'asc' %}desc{% else %}asc{% endif %}{% if active_turn %}&turn={{ active_turn.turn_id }}{% endif %}{% if show_system %}&system=1{% endif %}">
                        Updated
                      </a>
                    </th>
                  </tr>
                </thead>

                <tbody>
                  {% for t in turn_items %}
                    <tr data-pinned="{% if t.is_pinned %}1{% else %}0{% endif %}" class="{% if active_turn and t.turn_id == active_turn.turn_id %}rw-turn-row-active{% endif %}{% if t.is_rolled_up %} msg-rolled-up{% endif %}{% if t.is_pinned %} msg-pinned{% endif %}{% if t.is_ignored %} msg-ignored{% endif %}">
                      <td>
                        <a class="rw-turn-rowlink"
                           href="?{% if fullscreen %}fullscreen=1&{% endif %}turn={{ t.turn_id }}{% if turn_sort %}&turn_sort={{ turn_sort }}{% endif %}{% if turn_dir %}&turn_dir={{ turn_dir }}{% endif %}{% if show_system %}&system=1{% endif %}">
                          {{ t.number }}
                        </a>
                      </td>
                      <td>
                        <a class="rw-turn-rowlink"
                           href="?{% if fullscreen %}fullscreen=1&{% endif %}turn={{ t.turn_id }}{% if turn_sort %}&turn_sort={{ turn_sort }}{% endif %}{% if turn_dir %}&turn_dir={{ turn_dir }}{% endif %}{% if show_system %}&system=1{% endif %}">
                          {{ t.title|default:"(no input)"|truncatechars:60 }}
                        </a>
                      </td>
                      <td>
                        <a class="rw-turn-rowlink"
                           href="?{% if fullscreen %}fullscreen=1&{% endif %}turn={{ t.turn_id }}{% if turn_sort %}&turn_sort={{ turn_sort }}{% endif %}{% if turn_dir %}&turn_dir={{ turn_dir }}{% endif %}{% if show_system %}&system=1{% endif %}">
                          {{ t.created_at|date:"Y-m-d H:i" }}
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="rw-turn-detail">
              {% if not active_turn %}
                <div class="alert alert-secondary mb-0">Select a turn to view its panes.</div>
              {% else %}
                {% with pane=active_turn %}
                  <textarea id="rw-active-answer" class="d-none" aria-hidden="true">{{ pane.answer|default:"" }}</textarea>
                  <textarea id="rw-active-output" class="d-none" aria-hidden="true">{{ pane.output|default:"" }}</textarea>
                  <div class="d-flex flex-column gap-2">
                    {% if not is_system_turn %}
                      <details open class="rw-channel">
                        <summary class="fw-semibold">INPUT</summary>
                        <div class="pt-2">
                          {% if pane.input %}
                            <div class="rw-message{% if pane.input.importance == 'PINNED' %} msg-pinned{% endif %}{% if pane.input.importance == 'IGNORE' %} msg-ignored{% endif %}{% if chat.pinned_cursor_message_id and pane.input.id <= chat.pinned_cursor_message_id %} msg-rolled-up{% endif %}">
                              <div class="rw-message-body">{{ pane.input.raw_text|linebreaksbr }}</div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No input.</div>
                          {% endif %}
                        </div>
                      </details>

                        <details open class="rw-channel">
                          <summary class="fw-semibold">ANSWER</summary>
                          <div class="pt-2">
                            {% if pane.answer %}
                              <div class="rw-message{% if pane.assistant and pane.assistant.importance == 'PINNED' %} msg-pinned{% endif %}{% if pane.assistant and pane.assistant.importance == 'IGNORE' %} msg-ignored{% endif %}{% if pane.assistant and chat.pinned_cursor_message_id and pane.assistant.id <= chat.pinned_cursor_message_id %} msg-rolled-up{% endif %}">
                                <div class="rw-message-body">{{ pane.answer|linebreaksbr }}</div>
                              </div>
                              {% if pane.assistant %}
                                <div class="d-flex gap-1 mt-2">
                                  {% if pane.assistant.importance == 'PINNED' %}
                                    <form method="post" action="{% url 'accounts:message_set_importance' pane.assistant.id %}" class="m-0">
                                      {% csrf_token %}
                                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                      <input type="hidden" name="importance" value="NORMAL">
                                      <button type="submit" class="btn btn-sm btn-outline-primary">Unpin</button>
                                    </form>
                                  {% elif pane.input and pane.input.importance == 'PINNED' %}
                                    <form method="post" action="{% url 'accounts:message_set_importance' pane.input.id %}" class="m-0">
                                      {% csrf_token %}
                                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                      <input type="hidden" name="importance" value="NORMAL">
                                      <button type="submit" class="btn btn-sm btn-outline-primary">Unpin</button>
                                    </form>
                                  {% else %}
                                    <form method="post" action="{% url 'accounts:message_set_importance' pane.assistant.id %}" class="m-0">
                                      {% csrf_token %}
                                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                      <input type="hidden" name="importance" value="PINNED">
                                      <button type="submit" class="btn btn-sm btn-outline-primary">Pin</button>
                                    </form>
                                  {% endif %}
                                  {% if pane.assistant.importance == 'IGNORE' %}
                                    <form method="post" action="{% url 'accounts:message_set_importance' pane.assistant.id %}" class="m-0">
                                      {% csrf_token %}
                                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                      <input type="hidden" name="importance" value="NORMAL">
                                      <button type="submit" class="btn btn-sm btn-outline-secondary">Unignore</button>
                                    </form>
                                  {% else %}
                                    <form method="post" action="{% url 'accounts:message_set_importance' pane.assistant.id %}" class="m-0">
                                      {% csrf_token %}
                                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                      <input type="hidden" name="importance" value="IGNORE">
                                      <button type="submit" class="btn btn-sm btn-outline-secondary">Ignore</button>
                                    </form>
                                  {% endif %}
                                </div>
                              {% endif %}
                            {% else %}
                              <div class="text-secondary small">No ANSWER.</div>
                            {% endif %}
                          </div>
                        </details>
                      <details class="rw-channel">
                        <summary class="fw-semibold">OUTPUT</summary>
                        <div class="pt-2">
                          {% if pane.output %}
                            <div class="rw-message">
                              <div class="rw-message-body">{{ pane.output|linebreaksbr }}</div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No OUTPUT.</div>
                          {% endif %}
                        </div>
                      </details>

                      <details class="rw-channel">
                        <summary class="fw-semibold">REASONING</summary>
                        <div class="pt-2">
                          {% if pane.reasoning %}
                            <div class="rw-message">
                              <div class="rw-message-body">{{ pane.reasoning|linebreaksbr }}</div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No REASONING.</div>
                          {% endif %}
                        </div>
                      </details>
                    {% endif %}

                    {% if show_system %}
                      <details class="rw-channel">
                        <summary class="fw-semibold">SYSTEM</summary>

                        <div class="pt-2">
                          {% if system_latest %}
                            <div class="rw-message mb-2">
                              <div class="rw-message-body">
                                <div class="small text-secondary mb-1">Latest per axis</div>
                                <div class="d-flex flex-column gap-1">
                                  {% for k, v in system_latest.items %}
                                    <div>
                                      <span class="fw-semibold">{{ k }}:</span>
                                      {% if v %}
                                        {{ v.value }}
                                        <span class="text-secondary small">(id {{ v.id }})</span>
                                      {% else %}
                                        <span class="text-secondary">-</span>
                                      {% endif %}
                                    </div>
                                  {% endfor %}
                                </div>
                              </div>
                            </div>
                          {% endif %}

                          {% if system_preview %}
                            <div class="rw-message">
                              <div class="rw-message-body rw-system-body">
                                {{ system_preview|linebreaksbr }}
                              </div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No SYSTEM preview.</div>
                          {% endif %}
                        </div>
                      </details>
                    {% endif %}

                  </div>
                {% endwith %}
              {% endif %}
            </div>

          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<script>
  // ------------------------------------------------------------
  // Turn list scroll restore (per chat)
  // ------------------------------------------------------------
  (function () {
    var list = document.querySelector(".rw-turn-list");
    if (!list) return;

    var chatId = "{{ chat.id }}";
    var key = "rw_turn_scroll_chat_" + chatId;

    var saved = sessionStorage.getItem(key);
    if (saved !== null) {
      list.scrollTop = parseInt(saved, 10);
    }

    list.addEventListener("scroll", function () {
      sessionStorage.setItem(key, list.scrollTop);
    });
  })();
  (function () {
    var modeInput = document.getElementById("rw-answer-mode");
    var buttons = document.querySelectorAll("button[data-answer-mode]");
    if (!modeInput || !buttons.length) return;
    var modeEndpoint = "{% url 'accounts:session_overrides_update' %}";

    function getCsrfToken() {
      var parts = ("; " + document.cookie).split("; csrftoken=");
      if (parts.length < 2) return "";
      return parts.pop().split(";").shift();
    }

    function persistMode(mode) {
      return fetch(modeEndpoint, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken()
        },
        body: JSON.stringify({ axis: "answer_mode", value: mode })
      }).then(function (resp) {
        return resp.json().then(function (data) {
          if (!resp.ok || !data || !data.ok) {
            throw new Error((data && data.error) ? data.error : "Failed to save answer mode.");
          }
          return data;
        });
      });
    }

    function setMode(mode) {
      modeInput.value = mode;
      buttons.forEach(function (b) {
        var active = (b.getAttribute("data-answer-mode") === mode);
        b.classList.toggle("active", active);
        b.classList.toggle("btn-primary", active);
        b.classList.toggle("btn-outline-secondary", !active);
      });
    }
    buttons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var selectedMode = btn.getAttribute("data-answer-mode") || "quick";
        setMode(selectedMode);
        persistMode(selectedMode).catch(function (err) {
          alert("Could not save mode: " + (err && err.message ? err.message : String(err)));
        });
      });
    });
    setMode(modeInput.value || "quick");
  })();

  // ------------------------------------------------------------
  // Use selected text for topic chats
  // ------------------------------------------------------------
  (function () {
    var form = document.getElementById("rw-use-selected-form");
    if (!form) return;
    var textInput = document.getElementById("rw-selected-text");
    var modeInput = document.getElementById("rw-selected-mode");
    var buttons = form.querySelectorAll("button[data-apply-mode]");
    if (!textInput || !modeInput || !buttons.length) return;

    function getSelectedText() {
      var sel = window.getSelection ? window.getSelection() : null;
      if (!sel) return "";
      return String(sel).trim();
    }

    function getInputText() {
      var el = document.getElementById("rw-chat-input");
      if (el && String(el.value || "").trim()) {
        return String(el.value || "").trim();
      }
      var ansEl = document.getElementById("rw-active-answer");
      if (ansEl && String(ansEl.value || "").trim()) {
        return String(ansEl.value || "").trim();
      }
      var outEl = document.getElementById("rw-active-output");
      if (outEl && String(outEl.value || "").trim()) {
        return String(outEl.value || "").trim();
      }
      return "";
    }

    buttons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        var src = btn.getAttribute("data-source") || "selected";
        var txt = (src === "input") ? getInputText() : getSelectedText();
        if (!txt) {
          alert(src === "input" ? "Type/paste JSON or select a turn with OUTPUT first." : "Select text in the chat first.");
          return;
        }
        var mode = btn.getAttribute("data-apply-mode") || "replace";
        textInput.value = txt;
        modeInput.value = mode;
        form.submit();
      });
    });
  })();

  // ------------------------------------------------------------
  // Attachments: upload (paste + file picker) and delete
  // ------------------------------------------------------------
  (function () {
    function getCsrfToken() {
      var el = document.querySelector("input[name=csrfmiddlewaretoken]");
      return el ? el.value : "";
    }

    function humanSize(n) {
      if (!n && n !== 0) return "";
      if (n < 1024) return n + " B";
      if (n < 1024 * 1024) return Math.round(n / 1024) + " KB";
      return Math.round(n / (1024 * 1024)) + " MB";
    }

    async function uploadFileToServer(fileOrBlob, filename, source) {
      var url = window.RW_PASTE_UPLOAD_URL;
      if (!url) throw new Error("Missing RW_PASTE_UPLOAD_URL");

      var fd = new FormData();
      fd.append("file", fileOrBlob, filename || "upload.bin");
      fd.append("source", source || "");

      var resp = await fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": getCsrfToken() },
        body: fd,
        credentials: "same-origin"
      });

      if (!resp.ok) {
        var txt = await resp.text();
        throw new Error("Upload failed: " + txt);
      }
      return await resp.json();
    }

    async function deleteAttachment(attachmentId) {
      var tmpl = window.RW_ATTACHMENT_DELETE_URL_TEMPLATE;
      if (!tmpl) throw new Error("Missing delete URL template");

      var url = tmpl.replace("/0/", "/" + String(attachmentId) + "/");
      var fd = new FormData();

      var resp = await fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": getCsrfToken() },
        body: fd,
        credentials: "same-origin"
      });

      if (!resp.ok) {
        var txt = await resp.text();
        throw new Error("Delete failed: " + txt);
      }
      return await resp.json();
    }

    function addStatusLine(text) {
      var box = document.getElementById("rw-paste-status");
      if (!box) return null;
      var div = document.createElement("div");
      div.textContent = text;
      box.appendChild(div);
      return div;
    }

    function addUploadedLine(att) {
      var box = document.getElementById("rw-paste-status");
      if (!box) return;

      var row = document.createElement("div");
      row.className = "d-flex align-items-center gap-2";

      var label = document.createElement("span");
      label.textContent =
        "Uploaded: " +
        (att.name || "file") +
        " (" +
        humanSize(att.size_bytes) +
        ")";

      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-sm btn-outline-danger";
      btn.textContent = "Delete";

      btn.addEventListener("click", function () {
        if (!confirm("Delete this attachment?")) return;

        btn.disabled = true;
        deleteAttachment(att.id)
          .then(function (data) {
            if (data && data.ok) {
              row.remove();
            } else {
              btn.disabled = false;
              alert("Delete failed.");
            }
          })
          .catch(function (err) {
            btn.disabled = false;
            alert("Delete error: " + (err && err.message ? err.message : String(err)));
          });
      });

      row.appendChild(label);
      row.appendChild(btn);
      box.appendChild(row);
    }

    var input = document.getElementById("rw-chat-input");
    if (input) {
      input.addEventListener("paste", function (ev) {
        var items = ev.clipboardData && ev.clipboardData.items ? ev.clipboardData.items : null;
        if (!items) return;

        var foundImage = false;

        for (var i = 0; i < items.length; i++) {
          var it = items[i];
          if (it && it.type && it.type.indexOf("image/") === 0) {
            foundImage = true;

            var file = it.getAsFile();
            if (!file) continue;

            var line = addStatusLine("Pasting image: uploading...");
            uploadFileToServer(file, "pasted-image.png", "paste")
              .then(function (data) {
                if (data && data.ok && data.attachment) {
                  if (line) line.remove();
                  addUploadedLine(data.attachment);
                } else {
                  if (line) line.textContent = "Image upload: unexpected response";
                }
              })
              .catch(function (err) {
                if (line) {
                  line.textContent =
                    "Image upload error: " + (err && err.message ? err.message : String(err));
                }
              });
          }
        }

        if (foundImage) ev.preventDefault();
      });
    }

    var fileInput = document.getElementById("rw-file-input");
    if (fileInput) {
      fileInput.addEventListener("change", function () {
        var file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
        if (!file) return;

        var line = addStatusLine("Selected: " + file.name + " (uploading...)");

        uploadFileToServer(file, file.name, "filepicker")
          .then(function (data) {
            if (data && data.ok && data.attachment) {
              if (line) line.remove();
              addUploadedLine(data.attachment);
            } else {
              if (line) line.textContent = "Upload: unexpected response";
            }
          })
          .catch(function (err) {
            if (line) {
              line.textContent =
                "Upload error: " + (err && err.message ? err.message : String(err));
            }
          })
          .finally(function () {
            fileInput.value = "";
          });
      });
    }

    var list = document.getElementById("rw-attachment-list");
    if (list) {
      list.addEventListener("click", function (ev) {
        var btn =
          ev.target &&
          ev.target.classList &&
          ev.target.classList.contains("rw-attachment-delete")
            ? ev.target
            : null;
        if (!btn) return;

        var row = btn.closest("[data-attachment-id]");
        if (!row) return;

        var id = row.getAttribute("data-attachment-id");
        if (!id) return;

        if (!confirm("Delete this attachment?")) return;

        btn.disabled = true;

        deleteAttachment(id)
          .then(function (data) {
            if (data && data.ok) {
              row.remove();
            } else {
              btn.disabled = false;
              alert("Delete failed.");
            }
          })
          .catch(function (err) {
            btn.disabled = false;
            alert("Delete error: " + (err && err.message ? err.message : String(err)));
          });
      });
    }
    })();
    (function() {
      var draftKey = "rw_chat_draft_{{ chat.id }}";
      var inputEl = document.getElementById("rw-chat-input");
      var formEl = inputEl ? inputEl.closest("form") : null;
      if (inputEl) {
        try {
          var saved = localStorage.getItem(draftKey) || "";
          if (saved && !inputEl.value) {
            inputEl.value = saved;
          }
        } catch (e) {}
        var saveDraft = function () {
          try {
            localStorage.setItem(draftKey, inputEl.value || "");
          } catch (e) {}
        };
        inputEl.addEventListener("input", saveDraft);
        inputEl.addEventListener("blur", saveDraft);
      }
      if (formEl) {
        formEl.addEventListener("submit", function () {
          try {
            localStorage.removeItem(draftKey);
          } catch (e) {}
        });
      }
    })();
    (function() {
      // 7-bit ASCII: inline rename toggle
      var btn = document.getElementById("btnRename");
      var cancel = document.getElementById("btnRenameCancel");
      var view = document.getElementById("chatTitleView");
      var form = document.getElementById("chatTitleEdit");

      function showEdit(on) {
        if (!view || !form) return;
        view.classList.toggle("d-none", on);
        form.classList.toggle("d-none", !on);
        if (on) {
          var inp = form.querySelector("input[name='title']");
          if (inp) inp.focus();
        }
      }

      if (btn) btn.addEventListener("click", function() { showEdit(true); });
      if (cancel) cancel.addEventListener("click", function() { showEdit(false); });
    })();

</script>

{% endblock %}
