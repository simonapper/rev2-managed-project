{# -*- coding: utf-8 -*- #}
{# templates/accounts/chat_detail.html #}
{% extends "base.html" %}
{% block title %}{{ chat.title }} — Reasoning Workbench{% endblock %}

{% block content %}
<div class="rw-main-inner">
  <div class="rw-workarea">
    <div class="rw-pane">
      <div class="rw-pane-body pt-0 px-3 pb-3">

        <!--<hr class="my-3">-->

        <!-- Top row: controls + input -->
<form method="post" action="{% url 'accounts:chat_message_create' %}" enctype="multipart/form-data">
  {% csrf_token %}
  <input type="hidden" name="chat_id" value="{{ chat.id }}">
  <input type="hidden" name="next" value="{{ request.get_full_path }}">

  <div class="d-flex align-items-start gap-2 mb-2">
    <div class="flex-grow-1">
      <textarea id="rw-chat-input" name="content" class="form-control" rows="2" placeholder="Type message..."></textarea>
    </div>
    <div class="d-flex flex-column align-items-end gap-1" style="min-width: 160px;">
      {% if fullscreen %}
        <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_normal }}">Exit full screen</a>
      {% else %}
        <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_fullscreen }}">Full screen</a>
      {% endif %}

      {% if show_system %}
        <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_no_system }}">Hide system</a>
      {% else %}
        <a class="btn btn-outline-secondary rw-topbar-btn rw-btn-xs py-1 px-2" href="?{{ qs_with_system }}">Show system</a>
      {% endif %}
    </div>
  </div>

  <div class="d-flex align-items-center gap-2 mb-2">
    {% if not chat.project.kind == "SANDBOX" %}
      <span class="badge bg-primary" style="padding:.15rem .4rem; font-size:.7rem;">Controlled</span>
    {% endif %}
  </div>

  <div id="rw-paste-status" class="small text-secondary mt-2"></div>

  <!-- Select-a-file upload -->
  <div class="mt-2 d-flex align-items-center gap-2">
    <button type="button" class="btn btn-sm btn-primary rw-btn-same rw-btn-file" id="rw-file-btn">Select file</button>
    <input id="rw-file-input" type="file" style="display:none">
    <span id="rw-file-name" class="small text-secondary"></span>
    <button type="submit" class="btn btn-sm btn-success rw-btn-same">Send</button>
    <div class="ms-auto"></div>
  </div>

  {% if has_last_image %}
    <div class="form-check mt-2">
      <input class="form-check-input"
             type="checkbox"
             id="rw-include-last-image"
             name="include_last_image"
             value="1">
      <label class="form-check-label" for="rw-include-last-image">
        Include last image
      </label>
    </div>
  {% endif %}

  {% if has_last_file %}
    <div class="form-check mt-2">
      <input class="form-check-input"
             type="checkbox"
             id="rw-include-last-file"
             name="include_last_file"
             value="1">
      <label class="form-check-label" for="rw-include-last-file">
        Include last file
      </label>
    </div>
  {% endif %}

</form>

        {# Attachments list #}
        {% if attachments %}
          <div class="mb-3">
            <div class="text-secondary small mb-1">Attachments in this chat</div>
            <div class="list-group" id="rw-attachment-list">
              {% for a in attachments %}
                <div class="list-group-item d-flex justify-content-between align-items-center"
                     data-attachment-id="{{ a.id }}">
                  <div class="d-flex align-items-center gap-2">
                    <a href="{{ a.file.url }}">{{ a.original_name }}</a>
                    <span class="text-secondary small">{{ a.size_bytes }} bytes</span>
                  </div>

                  <button type="button" class="btn btn-sm btn-outline-danger rw-attachment-delete">
                    Delete
                  </button>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% if not turn_items %}
          <div class="alert alert-secondary mb-3">No messages yet.</div>
        {% else %}
          <div class="rw-turn-split">

            <div class="rw-turn-list">
              <table class="rw-turn-table">
                <thead>
                  <tr>
                    <th style="width:70px;">
                      <a href="?{% if fullscreen %}fullscreen=1&{% endif %}turn_sort=number&turn_dir={% if turn_sort == 'number' and turn_dir == 'asc' %}desc{% else %}asc{% endif %}{% if active_turn %}&turn={{ active_turn.turn_id }}{% endif %}{% if show_system %}&system=1{% endif %}">
                        Turn
                      </a>
                    </th>
                    <th>
                      <a href="?{% if fullscreen %}fullscreen=1&{% endif %}turn_sort=title&turn_dir={% if turn_sort == 'title' and turn_dir == 'asc' %}desc{% else %}asc{% endif %}{% if active_turn %}&turn={{ active_turn.turn_id }}{% endif %}{% if show_system %}&system=1{% endif %}">
                        Title
                      </a>
                    </th>
                    <th style="width:140px;">
                      <a href="?{% if fullscreen %}fullscreen=1&{% endif %}turn_sort=updated&turn_dir={% if turn_sort == 'updated' and turn_dir == 'asc' %}desc{% else %}asc{% endif %}{% if active_turn %}&turn={{ active_turn.turn_id }}{% endif %}{% if show_system %}&system=1{% endif %}">
                        Updated
                      </a>
                    </th>
                  </tr>
                </thead>

                <tbody>
                  {% for t in turn_items %}
                    <tr class="{% if active_turn and t.turn_id == active_turn.turn_id %}rw-turn-row-active{% endif %}">
                      <td>
                        <a class="rw-turn-rowlink"
                           href="?{% if fullscreen %}fullscreen=1&{% endif %}turn={{ t.turn_id }}{% if turn_sort %}&turn_sort={{ turn_sort }}{% endif %}{% if turn_dir %}&turn_dir={{ turn_dir }}{% endif %}{% if show_system %}&system=1{% endif %}">
                          {{ t.number }}
                        </a>
                      </td>
                      <td>
                        <a class="rw-turn-rowlink"
                           href="?{% if fullscreen %}fullscreen=1&{% endif %}turn={{ t.turn_id }}{% if turn_sort %}&turn_sort={{ turn_sort }}{% endif %}{% if turn_dir %}&turn_dir={{ turn_dir }}{% endif %}{% if show_system %}&system=1{% endif %}">
                          {{ t.title|default:"(no input)"|truncatechars:60 }}
                        </a>
                      </td>
                      <td>
                        <a class="rw-turn-rowlink"
                           href="?{% if fullscreen %}fullscreen=1&{% endif %}turn={{ t.turn_id }}{% if turn_sort %}&turn_sort={{ turn_sort }}{% endif %}{% if turn_dir %}&turn_dir={{ turn_dir }}{% endif %}{% if show_system %}&system=1{% endif %}">
                          {{ t.created_at|date:"Y-m-d H:i" }}
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="rw-turn-detail">
              {% if not active_turn %}
                <div class="alert alert-secondary mb-0">Select a turn to view its panes.</div>
              {% else %}
                {% with pane=active_turn %}
                  <div class="d-flex flex-column gap-2">
                    {% if not is_system_turn %}
                      <details open class="rw-channel">
                        <summary class="fw-semibold">INPUT</summary>
                        <div class="pt-2">
                          {% if pane.input %}
                            <div class="rw-message">
                              <div class="rw-message-body">{{ pane.input.raw_text|linebreaksbr }}</div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No input.</div>
                          {% endif %}
                        </div>
                      </details>

                        <details open class="rw-channel">
                          <summary class="fw-semibold">ANSWER</summary>
                          <div class="pt-2">
                            {% if pane.answer %}
                              <div class="rw-message">
                                <div class="rw-message-body">{{ pane.answer|linebreaksbr }}</div>
                              </div>
                            {% else %}
                              <div class="text-secondary small">No ANSWER.</div>
                            {% endif %}
                          </div>
                        </details>
                      <details class="rw-channel">
                        <summary class="fw-semibold">OUTPUT</summary>
                        <div class="pt-2">
                          {% if pane.output %}
                            <div class="rw-message">
                              <div class="rw-message-body">{{ pane.output|linebreaksbr }}</div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No OUTPUT.</div>
                          {% endif %}
                        </div>
                      </details>

                      <details class="rw-channel">
                        <summary class="fw-semibold">REASONING</summary>
                        <div class="pt-2">
                          {% if pane.reasoning %}
                            <div class="rw-message">
                              <div class="rw-message-body">{{ pane.reasoning|linebreaksbr }}</div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No REASONING.</div>
                          {% endif %}
                        </div>
                      </details>
                    {% endif %}

                    {% if show_system %}
                      <details class="rw-channel">
                        <summary class="fw-semibold">SYSTEM</summary>

                        <div class="pt-2">
                          {% if system_latest %}
                            <div class="rw-message mb-2">
                              <div class="rw-message-body">
                                <div class="small text-secondary mb-1">Latest per axis</div>
                                <div class="d-flex flex-column gap-1">
                                  {% for k, v in system_latest.items %}
                                    <div>
                                      <span class="fw-semibold">{{ k }}:</span>
                                      {% if v %}
                                        {{ v.value }}
                                        <span class="text-secondary small">(id {{ v.id }})</span>
                                      {% else %}
                                        <span class="text-secondary">-</span>
                                      {% endif %}
                                    </div>
                                  {% endfor %}
                                </div>
                              </div>
                            </div>
                          {% endif %}

                          {% if system_preview %}
                            <div class="rw-message">
                              <div class="rw-message-body rw-system-body">
                                {{ system_preview|linebreaksbr }}
                              </div>
                            </div>
                          {% else %}
                            <div class="text-secondary small">No SYSTEM preview.</div>
                          {% endif %}
                        </div>
                      </details>
                    {% endif %}

                  </div>
                {% endwith %}
              {% endif %}
            </div>

          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<script>
  // ------------------------------------------------------------
  // Turn list scroll restore (per chat)
  // ------------------------------------------------------------
  (function () {
    var list = document.querySelector(".rw-turn-list");
    if (!list) return;

    var chatId = "{{ chat.id }}";
    var key = "rw_turn_scroll_chat_" + chatId;

    var saved = sessionStorage.getItem(key);
    if (saved !== null) {
      list.scrollTop = parseInt(saved, 10);
    }

    list.addEventListener("scroll", function () {
      sessionStorage.setItem(key, list.scrollTop);
    });
  })();

  // ------------------------------------------------------------
  // Attachments: upload (paste + file picker) and delete
  // ------------------------------------------------------------
  (function () {
    function getCsrfToken() {
      var el = document.querySelector("input[name=csrfmiddlewaretoken]");
      return el ? el.value : "";
    }

    function humanSize(n) {
      if (!n && n !== 0) return "";
      if (n < 1024) return n + " B";
      if (n < 1024 * 1024) return Math.round(n / 1024) + " KB";
      return Math.round(n / (1024 * 1024)) + " MB";
    }

    async function uploadFileToServer(fileOrBlob, filename, source) {
      var url = window.RW_PASTE_UPLOAD_URL;
      if (!url) throw new Error("Missing RW_PASTE_UPLOAD_URL");

      var fd = new FormData();
      fd.append("file", fileOrBlob, filename || "upload.bin");
      fd.append("source", source || "");

      var resp = await fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": getCsrfToken() },
        body: fd,
        credentials: "same-origin"
      });

      if (!resp.ok) {
        var txt = await resp.text();
        throw new Error("Upload failed: " + txt);
      }
      return await resp.json();
    }

    async function deleteAttachment(attachmentId) {
      var tmpl = window.RW_ATTACHMENT_DELETE_URL_TEMPLATE;
      if (!tmpl) throw new Error("Missing delete URL template");

      var url = tmpl.replace("/0/", "/" + String(attachmentId) + "/");
      var fd = new FormData();

      var resp = await fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": getCsrfToken() },
        body: fd,
        credentials: "same-origin"
      });

      if (!resp.ok) {
        var txt = await resp.text();
        throw new Error("Delete failed: " + txt);
      }
      return await resp.json();
    }

    function addStatusLine(text) {
      var box = document.getElementById("rw-paste-status");
      if (!box) return null;
      var div = document.createElement("div");
      div.textContent = text;
      box.appendChild(div);
      return div;
    }

    function addUploadedLine(att) {
      var box = document.getElementById("rw-paste-status");
      if (!box) return;

      var row = document.createElement("div");
      row.className = "d-flex align-items-center gap-2";

      var label = document.createElement("span");
      label.textContent =
        "Uploaded: " +
        (att.name || "file") +
        " (" +
        humanSize(att.size_bytes) +
        ")";

      var btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-sm btn-outline-danger";
      btn.textContent = "Delete";

      btn.addEventListener("click", function () {
        if (!confirm("Delete this attachment?")) return;

        btn.disabled = true;
        deleteAttachment(att.id)
          .then(function (data) {
            if (data && data.ok) {
              row.remove();
            } else {
              btn.disabled = false;
              alert("Delete failed.");
            }
          })
          .catch(function (err) {
            btn.disabled = false;
            alert("Delete error: " + (err && err.message ? err.message : String(err)));
          });
      });

      row.appendChild(label);
      row.appendChild(btn);
      box.appendChild(row);
    }

    var input = document.getElementById("rw-chat-input");
    if (input) {
      input.addEventListener("paste", function (ev) {
        var items = ev.clipboardData && ev.clipboardData.items ? ev.clipboardData.items : null;
        if (!items) return;

        var foundImage = false;

        for (var i = 0; i < items.length; i++) {
          var it = items[i];
          if (it && it.type && it.type.indexOf("image/") === 0) {
            foundImage = true;

            var file = it.getAsFile();
            if (!file) continue;

            var line = addStatusLine("Pasting image: uploading...");
            uploadFileToServer(file, "pasted-image.png", "paste")
              .then(function (data) {
                if (data && data.ok && data.attachment) {
                  if (line) line.remove();
                  addUploadedLine(data.attachment);
                } else {
                  if (line) line.textContent = "Image upload: unexpected response";
                }
              })
              .catch(function (err) {
                if (line) {
                  line.textContent =
                    "Image upload error: " + (err && err.message ? err.message : String(err));
                }
              });
          }
        }

        if (foundImage) ev.preventDefault();
      });
    }

    var fileInput = document.getElementById("rw-file-input");
    if (fileInput) {
      fileInput.addEventListener("change", function () {
        var file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
        if (!file) return;

        var line = addStatusLine("Selected: " + file.name + " (uploading...)");

        uploadFileToServer(file, file.name, "filepicker")
          .then(function (data) {
            if (data && data.ok && data.attachment) {
              if (line) line.remove();
              addUploadedLine(data.attachment);
            } else {
              if (line) line.textContent = "Upload: unexpected response";
            }
          })
          .catch(function (err) {
            if (line) {
              line.textContent =
                "Upload error: " + (err && err.message ? err.message : String(err));
            }
          })
          .finally(function () {
            fileInput.value = "";
          });
      });
    }

    var list = document.getElementById("rw-attachment-list");
    if (list) {
      list.addEventListener("click", function (ev) {
        var btn =
          ev.target &&
          ev.target.classList &&
          ev.target.classList.contains("rw-attachment-delete")
            ? ev.target
            : null;
        if (!btn) return;

        var row = btn.closest("[data-attachment-id]");
        if (!row) return;

        var id = row.getAttribute("data-attachment-id");
        if (!id) return;

        if (!confirm("Delete this attachment?")) return;

        btn.disabled = true;

        deleteAttachment(id)
          .then(function (data) {
            if (data && data.ok) {
              row.remove();
            } else {
              btn.disabled = false;
              alert("Delete failed.");
            }
          })
          .catch(function (err) {
            btn.disabled = false;
            alert("Delete error: " + (err && err.message ? err.message : String(err)));
          });
      });
    }
    })();
    (function() {
      // 7-bit ASCII: inline rename toggle
      var btn = document.getElementById("btnRename");
      var cancel = document.getElementById("btnRenameCancel");
      var view = document.getElementById("chatTitleView");
      var form = document.getElementById("chatTitleEdit");

      function showEdit(on) {
        if (!view || !form) return;
        view.classList.toggle("d-none", on);
        form.classList.toggle("d-none", !on);
        if (on) {
          var inp = form.querySelector("input[name='title']");
          if (inp) inp.focus();
        }
      }

      if (btn) btn.addEventListener("click", function() { showEdit(true); });
      if (cancel) cancel.addEventListener("click", function() { showEdit(false); });
    })();

</script>

{% endblock %}
