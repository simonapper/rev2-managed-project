{# -*- coding: utf-8 -*- #}
{# templates/accounts/dashboard.html #}
{% extends "base.html" %}

{% block title %}Dashboard — Reasoning Workbench{% endblock %}

{% block content %}
<div class="rw-main-inner">

  {# Header: dashboard actions #}
  <div class="rw-breadcrumbs d-flex align-items-center">
    <div>
      <div class="fw-semibold">Dashboard</div>
      {% if active_project %}
        <div class="text-secondary small">Active project: {{ active_project.name }}</div>
      {% endif %}
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'accounts:chat_browse' %}">Browse chats</a>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'accounts:project_config_list' %}">Browse projects</a>

      {# Only enable New chat when active project is DEFINED (or is SANDBOX if you later choose). #}
        {% if active_project and active_project.defined_cko %}
        <a class="btn btn-sm btn-primary" href="{% url 'accounts:chat_create' %}">
          <i class="bi bi-plus-lg me-1"></i>New chat
        </a>
      {% else %}
        <button class="btn btn-sm btn-primary" disabled>
          <i class="bi bi-plus-lg me-1"></i>New chat
        </button>
      {% endif %}

      <a class="btn btn-sm btn-primary" href="{% url 'accounts:project_create' %}">
        <i class="bi bi-plus-lg me-1"></i>New project
      </a>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'accounts:config_menu' %}">Settings</a>
    </div>
  </div>

  <div class="rw-workarea">
    <div class="rw-pane">
      <div class="rw-pane-header d-flex align-items-center justify-content-between">
        {# intentionally blank for now #}
      </div>

      <div class="rw-pane-body p-3">

        {% if not recent_projects %}
          <div class="alert alert-secondary mb-0">
            You do not have access to any projects yet.
          </div>
        {% else %}

          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold">Recent projects</div>
            <a class="small text-secondary" href="{% url 'accounts:project_config_list' %}">View all projects</a>
          </div>

          <div class="mb-3">
              <div class="row g-2 rw-project-tiles">
                {% for p in recent_projects %}
                  <div class="col-12 col-sm-6 col-lg-2">
                    {# IMPORTANT: route through project_home so UNASSIGNED -> PDE, DEFINED -> post-commit area #}
                    <a class="rw-chat-tile-link" href="{% url 'accounts:project_home' p.id %}">
                      <div class="card rw-chat-tile h-100">
                        <div class="card-body">
                          <div class="rw-chat-title">
                            {{ p.name|default:"(unnamed project)"|truncatechars:60 }}
                          </div>
                          <div class="rw-chat-snippet text-muted">
                            Owner: {{ p.owner.username }}
                          </div>

                          {# Optional tiny status hint (ASCII only) #}
                          <div class="small text-muted mt-1">
                            Status:
                            {% if p.kind == "SANDBOX" %}
                              SANDBOX
                            {% elif p.defined_cko %}
                              DEFINED
                            {% else %}
                              UNASSIGNED
                            {% endif %}
                          </div>

                        </div>
                      </div>
                    </a>
                  </div>
                {% endfor %}
              </div>
            </div>

          </div>

          <hr class="my-3">

          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold">Recent chats</div>
            <a class="small text-secondary" href="{% url 'accounts:chat_browse' %}">View all chats</a>
          </div>

          <div class="mb-3">
            {% if chats %}
              <div class="row g-2 rw-chat-tiles">
                {% for c in chats %}
                  <div class="col-12 col-sm-6 col-lg-2">
                    <a class="rw-chat-tile-link {% if active_chat and c.id == active_chat.id %}rw-chat-tile-link-active{% endif %}"
                       href="{% url 'accounts:chat_detail' c.id %}">
                      <div class="card rw-chat-tile h-100">
                        <div class="card-body">
                          <div class="rw-chat-title">
                            {{ c.title|default:"(untitled)"|truncatechars:60 }}
                          </div>

                          {% if c.last_output_snippet %}
                            <div class="rw-chat-snippet text-muted">
                              {{ c.last_output_snippet|truncatechars:140 }}
                            </div>
                          {% else %}
                            <div class="rw-chat-snippet text-muted">-</div>
                          {% endif %}
                        </div>
                      </div>
                    </a>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-secondary small">No chats yet.</div>
            {% endif %}
          </div>

          <hr class="my-3">

          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold">Settings</div>
            <a class="small text-secondary" href="{% url 'accounts:config_menu' %}">Open settings</a>
          </div>

          <div class="d-flex flex-wrap gap-2 mb-3">
            <a class="btn btn-outline-primary btn-sm rw-config-btn" href="{% url 'accounts:user_config_user' %}">User</a>
            <a class="btn btn-outline-primary btn-sm rw-config-btn" href="{% url 'accounts:project_config_list' %}">Projects</a>
            {% if can_override_chat %}
              <a href="{% url 'accounts:chat_config_overrides' %}"
                 class="btn btn-outline-primary btn-sm rw-config-btn">
                This Chat
              </a>
            {% endif %}
            <a class="btn btn-outline-primary btn-sm rw-config-btn" href="{% url 'imports:preview_import' %}">Import Chats</a>
          </div>

          <hr class="my-3">

          {% comment %}
            (Old master-detail turn UI removed / disabled during model refactor)
          {% endcomment %}

        {% endif %}

      </div>
    </div>
  </div>

</div>
{% endblock %}
