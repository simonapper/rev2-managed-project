{# -*- coding: utf-8 -*- #}
{# templates/accounts/chat_browse.html #}
{% extends "base.html" %}
{% block title %}Browse Chats — Reasoning Workbench{% endblock %}

{% block content %}

<div class="container-fluid px-4 pt-1 pb-3 rw-browse">
    {% if active_project %}
      <div class="text-secondary small">Project: {{ active_project.name }}</div>
    {% endif %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h5 class="mb-1">Browse Chats</h5>
      <div class="text-secondary small">Fast list view across accessible projects</div>
    </div>
    <a class="btn btn-sm rw-btn-xs btn-outline-secondary" href="{% url 'accounts:chat_browse_print' %}?{{ request.GET.urlencode }}" target="_blank" rel="noopener">Print</a>
  </div>

  <details class="rw-drawer mb-3">
    <summary class="fw-semibold">Details</summary>
    <div class="pt-2">
      <form method="post" action="{% url 'accounts:chat_import' %}" enctype="multipart/form-data" class="row g-2 align-items-end mb-2">
        {% csrf_token %}
        <div class="col-sm-4 col-md-3">
          <label class="form-label small text-secondary mb-1">Import chat to project</label>
          <select name="project_id" class="form-select form-select-sm" required>
            <option value="">Select project</option>
            {% for p in projects %}
              <option value="{{ p.id }}" {% if active_project and active_project.id == p.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-5 col-md-6">
          <label class="form-label small text-secondary mb-1">Chat export ZIP</label>
          <input type="file" name="chat_file" class="form-control form-control-sm" accept=".zip" required>
        </div>
        <div class="col-sm-3 col-md-3">
          <button class="btn btn-sm rw-btn-xs btn-outline-primary w-100" type="submit">Import chat</button>
        </div>
      </form>

      <form method="get" class="row g-2 align-items-end mb-0">
        <div class="col-sm-4 col-md-3">
          <label class="form-label small text-secondary mb-1">Project</label>
          <select name="project" class="form-select form-select-sm">
            <option value="" {% if not filters.project %}selected{% endif %}>All</option>
            {% for p in projects %}
              <option value="{{ p.id }}" {% if filters.project|add:"" == p.id|stringformat:"s" %}selected{% endif %}>
                {{ p.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-sm-3 col-md-2">
          <label class="form-label small text-secondary mb-1">Status</label>
          <select name="status" class="form-select form-select-sm">
            <option value="ACTIVE" {% if filters.status == "ACTIVE" %}selected{% endif %}>Active</option>
          </select>
        </div>

        <div class="col-sm-5 col-md-5">
          <label class="form-label small text-secondary mb-1">Search</label>
          <input name="q" class="form-control form-control-sm" value="{{ filters.q }}" placeholder="Title / output / project / user">
        </div>

        <div class="col-sm-12 col-md-2">
          <button class="btn btn-sm rw-btn-xs btn-primary w-100" type="submit">Filter</button>
        </div>
      </form>
    </div>
  </details>

  <div class="card rw-browse-table-card">
    <div class="card-body p-0">

      {% if page_obj.object_list %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0 rw-chat-table">
            <thead>
              <tr>
                <th>
                  <a href="?sort=title&dir={% if sort == 'title' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Chat
                    {% if sort == 'title' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>
                  <a href="?sort=project&dir={% if sort == 'project' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Project
                    {% if sort == 'project' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>
                  <a href="?sort=owner&dir={% if sort == 'owner' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Owner
                    {% if sort == 'owner' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>
                  <a href="?sort=turns&dir={% if sort == 'turns' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Turns
                    {% if sort == 'turns' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th class="rw-updated-col">
                  <a href="?sort=updated&dir={% if sort == 'updated' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Updated
                    {% if sort == 'updated' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>Last answer</th>
                <th></th>
              </tr>
            </thead>

            <tbody>
              {% for c in page_obj.object_list %}
                {% with row_color=c.row_color %}
                <tr>
                  <td class="fw-semibold" style="background-color: {{ row_color }};">{{ c.title }}</td>
                  <td class="text-secondary" style="background-color: {{ row_color }};">{{ c.project.name }}</td>
                  <td class="text-secondary" style="background-color: {{ row_color }};">{{ c.created_by.username }}</td>
                  <td class="text-center text-secondary small" style="background-color: {{ row_color }};">{{ c.turn_count }}</td>
                  <td class="text-secondary rw-updated-col" style="background-color: {{ row_color }};">{{ c.updated_at }}</td>
                 <td class="text-secondary small" style="background-color: {{ row_color }};">
                   {% if c.last_answer_snippet or c.last_output_snippet %}
                     {{ c.last_answer_snippet|default:c.last_output_snippet|truncatechars:150 }}
                   {% else %}
                     (empty)
                   {% endif %}
                </td>         
                  <td class="text-end" style="background-color: {{ row_color }};">
                    <div class="d-inline-flex gap-1">

                    <a class="btn btn-sm rw-btn-xs btn-outline-secondary rw-chat-action"
                       href="{% url 'accounts:chat_detail' c.id %}">
                      Open
                    </a>
                    {% if request.user.is_superuser or c.project.owner_id == request.user.id %}
                        <form method="post"
                            action="{% url 'accounts:chat_export' c.id %}"
                            class="d-inline">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn btn-sm rw-btn-xs btn-outline-primary rw-chat-action"
                                onclick="return confirm('Export this chat to ZIP?');">
                          Export
                        </button>
                        </form>

                        <form method="post"
                            action="{% url 'accounts:chat_delete' c.id %}"
                            class="d-inline">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn btn-sm rw-btn-xs btn-outline-danger rw-chat-action"
                                onclick="return confirm('Permanently delete this chat?');">
                          Delete
                        </button>
                        </form>
                    {% endif %}

                    </div>
                </td>



                </tr>
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-secondary small">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </div>

         <div class="btn-group">
          {% if page_obj.has_previous %}
            <a class="btn btn-sm rw-btn-xs btn-outline-secondary"
               href="?project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}&sort={{ sort }}&dir={{ dir }}&page={{ page_obj.previous_page_number }}">
              Prev
            </a>
          {% endif %}
          {% if page_obj.has_next %}
            <a class="btn btn-sm rw-btn-xs btn-outline-secondary"
               href="?project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}&sort={{ sort }}&dir={{ dir }}&page={{ page_obj.next_page_number }}">
              Next
            </a>
          {% endif %}
        </div>
      {% else %}
        <div class="text-secondary small">No chats found.</div>
      {% endif %}

    </div>
  </div>

</div>
{% endblock %}
