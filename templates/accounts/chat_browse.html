{# -*- coding: utf-8 -*- #}
{# templates/accounts/chat_browse.html #}
{% extends "base.html" %}
{% block title %}Browse Chats — Reasoning Workbench{% endblock %}

{% block content %}

<div class="container-fluid px-4 py-4 rw-browse">
    {% if active_project %}
      <div class="text-secondary small">Project: {{ active_project.name }}</div>
    {% endif %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h5 class="mb-1">Browse Chats</h5>
      <div class="text-secondary small">Fast list view across accessible projects</div>
    </div>
        <div class="d-flex gap-2">
          <a href="{% url 'accounts:chat_create' %}" class="btn btn-sm btn-primary">New chat</a>
          <a href="{% url 'accounts:dashboard' %}" class="btn btn-sm btn-outline-secondary">Back</a>
        </div>
  </div>

  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-sm-4 col-md-3">
      <label class="form-label small text-secondary mb-1">Project</label>
      <select name="project" class="form-select form-select-sm">
        <option value="">All</option>
        {% for p in projects %}
          <option value="{{ p.id }}" {% if filters.project|add:"" == p.id|stringformat:"s" %}selected{% endif %}>
            {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-sm-3 col-md-2">
      <label class="form-label small text-secondary mb-1">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">All</option>
        <option value="ACTIVE" {% if filters.status == "ACTIVE" %}selected{% endif %}>Active</option>
        <option value="ARCHIVED" {% if filters.status == "ARCHIVED" %}selected{% endif %}>Archived</option>compact
      </select>
    </div>

    <div class="col-sm-5 col-md-5">
      <label class="form-label small text-secondary mb-1">Search</label>
      <input name="q" class="form-control form-control-sm" value="{{ filters.q }}" placeholder="Title / output / project / user">
    </div>

    <div class="col-sm-12 col-md-2">
      <button class="btn btn-sm btn-primary w-100" type="submit">Filter</button>
    </div>
  </form>

  <div class="card rw-browse-table-card">
    <div class="card-body p-0">

      {% if page_obj.object_list %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0 rw-chat-table">
            <thead>
              <tr>
                <th>
                  <a href="?sort=title&dir={% if sort == 'title' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Chat
                    {% if sort == 'title' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>
                  <a href="?sort=project&dir={% if sort == 'project' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Project
                    {% if sort == 'project' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>
                  <a href="?sort=owner&dir={% if sort == 'owner' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Owner
                    {% if sort == 'owner' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>
                  <a href="?sort=turns&dir={% if sort == 'turns' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Turns
                    {% if sort == 'turns' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th class="rw-updated-col">
                  <a href="?sort=updated&dir={% if sort == 'updated' and dir == 'asc' %}desc{% else %}asc{% endif %}&project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}">
                    Updated
                    {% if sort == 'updated' %}{% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>Last output</th>
                <th></th>
              </tr>
            </thead>

            <tbody>
              {% for c in page_obj.object_list %}
                <tr>
                  <td class="fw-semibold">{{ c.title }}</td>
                  <td class="text-secondary">{{ c.project.name }}</td>
                  <td class="text-secondary">{{ c.created_by.username }}</td>
                  <td class="text-center text-secondary small">{{ c.turn_count }}</td>
                  <td class="text-secondary rw-updated-col">{{ c.updated_at }}</td>
                 <td class="text-secondary small">
                   {% if c.last_output_snippet %}
                     {{ c.last_output_snippet|truncatechars:150|default:"(empty)" }}
                   {% else %}
                     (empty)
                   {% endif %}
                </td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{% url 'accounts:chat_detail' c.id %}">
                      Open
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-secondary small">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </div>

         <div class="btn-group">
          {% if page_obj.has_previous %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}&sort={{ sort }}&dir={{ dir }}&page={{ page_obj.previous_page_number }}">
              Prev
            </a>
          {% endif %}
          {% if page_obj.has_next %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?project={{ filters.project }}&status={{ filters.status }}&q={{ filters.q }}&sort={{ sort }}&dir={{ dir }}&page={{ page_obj.next_page_number }}">
              Next
            </a>
          {% endif %}
        </div>
      {% else %}
        <div class="text-secondary small">No chats found.</div>
      {% endif %}

    </div>
  </div>

</div>
{% endblock %}
